<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<title>A Simple Turing Machine Editor</title>
<link href="tm.css" rel="stylesheet" type="text/css">
<script src="emulator.js"></script>
<script src="tape.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="tmdisplay.js"></script>
<script src="machine.js"></script>
<script src="download.js"></script>
<script src="sidepanel.js"></script>
<script src="emulator_test_data.js"></script>
<script> 
var width = 1260,
    height = 700,
    editedEdge;
var graph = {
  "nodes": [{
    "x": 300,
    "y": 300
  },
  {
    "x": 200,
    "y": 200
  }],
  "links": [{
    "source": 0,
    "target": 1
  }]
};
var currX = 100;
var machine = buildMachine(graph);
var gui, sidePanel;

function buildGUI() {
  sidePanel = buildSidePanel(".sidePanel");
  gui = setupGUI(width, height, ".gui", machine, sidePanel, updateSelected);
}

function addNode() {
  machine.addNode({
      "x": currX,
      "y": 100
    });
  gui.updateGraph(machine);
  currX += 100;
  if(currX > width) currX = 100;
}

function deleteSelected() {
  var selected = gui.getSelected();
  selected.forEach(function(d) { machine.deleteNode(d); });
  gui.updateGraph(machine);
}

function load(json) {
  machine.setData(JSON.parse(json));
  gui.updateGraph(machine);
}

function loadString() {
  d3.select('.json').style('display', 'none');
  var json = prompt("Please enter the JSON for a Turing Machine:");
  if(json != null)
    load(json);
}

function updateSelected(selected) {
  var str = "Selected states:";
  var accepting = true, rejecting = true, neither = true;
  selected.each(function(d) { 
    if(!d.accept) accepting = false;
    if(!d.reject) rejecting = false;
    if(d.reject || d.accept) neither = false;
    str += " " + d.name + ",";
  });
  if(selected.node() == null) {
    accepting = false;
    rejecting = false;
    neither = false;
  } else {
    str = str.substring(0, str.length - 1);
  }
  d3.select(".acceptButton").classed("marked", accepting);
  d3.select(".rejectButton").classed("marked", rejecting);
  d3.select(".neitherButton").classed("marked", neither);
  document.getElementById("selectedText").innerHTML = str;
}

function loadFile() {
  var files = document.getElementById("fileInput").files;
  if(files.length < 1) return;
  var file = files[0];
  var reader = new FileReader();

  reader.onload = function(e) {
    load(reader.result);
  }

  reader.readAsText(file);
}

function setState(accept, reject) {
  machine.setState(accept, reject);
  gui.selectedChanged();
  gui.updateGraph(machine);
}

function setStart() {
  machine.setStart();
  gui.updateGraph(machine);
}

function openFileInput() {
  d3.select('.json').style('display', 'none');
  if (window.File) {
    document.getElementById("fileInput").click();
  } else {
    alert("Sorry, your browser doesn't support the File API. Please load from a string instead.");
  }
}
function closeModal(type) {
  d3.select(type).style('display', 'none');
  d3.select('.overlay').style('display', 'none');
}

function changeEdge() {
  var edge = editedEdge;
  var transition = {
    toNode: d3.select(".toName").node().value,
    direction: d3.select(".direction").node().value.toUpperCase() == "R",
    toChar: d3.select(".toChar").node().value,
    fromChar: d3.select(".fromChar").node().value
  };
  if(typeof edge !== 'string') {
    transition.fromNode = edge.fromNode;
    machine.removeTransition(edge.fromNode, edge);
    machine.addTransition(edge.fromNode, transition);
  } else {
    transition.fromNode = edge;
    machine.addTransition(edge, transition);
  }
  closeModal(".edgeEntry");
  gui.updateGraph(machine);
}

function openEdge(edge) {
  editedEdge = edge;
  if(typeof edge !== 'string') {
    d3.select(".fromName").node().innerHTML = edge.fromNode;
    d3.select(".fromChar").node().value = edge.fromChar;
    d3.select(".toChar").node().value = edge.toChar;
    d3.select(".direction").node().value = edge.direction ? "R" : "L";
    d3.select(".toName").node().value = edge.toNode;
  } else {
    d3.select(".fromName").node().innerHTML = edge;
    d3.select(".fromChar").node().value = "";
    d3.select(".toChar").node().value = "";
    d3.select(".direction").node().value = "";
    d3.select(".toName").node().value = "";
  }
  openModal(".edgeEntry");
}

function runTest() {
  var testCase = d3.select(".testCase").node().value;
  var em = new Emulator(machine.getData(), testCase);
  var result = em.run() ? "Accepted" : "Rejected";
  result = em.getTape() + ", " + result;
  d3.select(".testResult").node().innerHTML = result;
}

function openModal(type) {
  d3.select(type).style('display', 'inline');
  d3.select('.overlay').style('display', 'inline');
}
</script>
</head><body onload="buildGUI()">
<div class="menu">
  <button type="button" onclick="addNode()">+ Add New State</button>
  <span id="selectedText">Selected states:</span>
  <button type="button" class="acceptButton" onclick="setState(true, false)">&#x2713; Accepting</button>
  <button type="button" class="rejectButton" onclick="setState(false, true)">&#x2717; Rejecting</button>
  <button type="button" class="neitherButton" onclick="setState(false, false)">&#x25cb; Neither</button>
  <button type="button" onclick="setStart()">&#x2192; Set as Start</button>
  <button type="button" onclick="deleteSelected()">Delete Selected</button>
  <!--
  TODO: This currently isn't working. The issue appears to be that stylesheets aren't taken into account, 
  but I'm not sure how to fix that. document.styleSheets doesn't seem to be scraping the css properly.
  <button type="button" onclick="downloadAsPng(d3.select('svg'))">Download as PNG</button>
  -->
  <input class="fileInput" id="fileInput" type="file" onchange="loadFile();">
  <button type="button" onclick="openModal('.json')">Load</button>
  <button type="button" onclick="downloadAsJson(machine.getSaveData(), 'tm.json')">Download as JSON</button>
  <button type="button" onclick="openModal('.testing')">Run test</button>
</div>
<div class="gui"></div>
<div class="sidePanel"></div>
  <div class="overlay">
  <div class="edgeEntry popup">Transition for <span class="fromName">q2</span><br />
    <table>
      <tr>
        <td>On input</td>
        <td><input type="text" class="fromChar" size="1"></td>
      </tr>
      <tr>
        <td>Write</td>
        <td><input type="text" class="toChar" size="1"></td>
      </tr>
      <tr>
        <td>Move tape head</td>
        <td><input type="text" class="direction" size="1"></td>
      </tr>
      <tr>
        <td>Transition to</td>
        <td><input type="text" class="toName" size="1"></td>
      </tr>
    </table>
    <button type="button" onclick="closeModal('.edgeEntry')">Cancel</button>
    <button type="button" onclick="changeEdge()">Change</button>
  </div>
  <div class="json popup">
    <button type="button" onclick="closeModal('.json')">Cancel</button>
    <button type="button" onclick="openFileInput()">Load from File</button>
    <button type="button" onclick="loadString()">Load from JSON string</button>
  </div>
  <div class="testing popup">
    Test case: <input type="text" class="testCase" size="25">
    <button type="button" onclick="runTest()">Run</button><br /><br />
    Result: <div class="testResult"></div><br />
    <button type="button" onclick="closeModal('.testing')">Close</button>
  </div>
</div>
</body></html>
