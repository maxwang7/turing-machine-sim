<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<title>A Simple Turing Machine Editor</title>
<link href="tm.css" rel="stylesheet" type="text/css">
<script src="emulator.js"></script>
<script src="tape.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="tmdisplay.js"></script>
<script src="machine.js"></script>
<script src="download.js"></script>
<script src="sidepanel.js"></script>
<script src="emulator_test_data.js"></script>
<script> 
var width = 1260,
    height = 700;
var graph = {
  "nodes": [{
    "x": 300,
    "y": 300
  },
  {
    "x": 200,
    "y": 200
  }],
  "links": [{
    "source": 0,
    "target": 1
  }]
};
var currX = 100;
var machine = buildMachine(graph);
var gui, sidePanel;

function buildGUI() {
  sidePanel = buildSidePanel(".sidePanel");
  gui = setupGUI(width, height, ".gui", machine, sidePanel, updateSelected);
}

function addNode() {
  machine.addNode({
      "x": currX,
      "y": 100
    });
  gui.updateGraph(machine);
  currX += 100;
  if(currX > width) currX = 100;
}

function deleteSelected() {
  var selected = gui.getSelected();
  selected.forEach(function(d) { machine.deleteNode(d); });
  gui.updateGraph(machine);
}

function load(json) {
  machine.setData(JSON.parse(json));
  gui.updateGraph(machine);
}

function loadString() {
  var json = prompt("Please enter the JSON for a Turing Machine:");
  if(json != null)
    load(json);
}

function updateSelected(selected) {
  console.log("aids");
  var str = "Selected states:";
  var accepting = true, rejecting = true, neither = true;
  selected.each(function(d) { 
    if(!d.accept) accepting = false;
    if(!d.reject) rejecting = false;
    if(d.reject || d.accept) neither = false;
    str += " " + d.name + ",";
  });
  if(selected.node() == null) {
    accepting = false;
    rejecting = false;
    neither = false;
  } else {
    str = str.substring(0, str.length - 1);
  }
  console.log(accepting + " " + rejecting + " " + neither);
  d3.select(".acceptButton").classed("marked", accepting);
  d3.select(".rejectButton").classed("marked", rejecting);
  d3.select(".neitherButton").classed("marked", neither);
  document.getElementById("selectedText").innerHTML = str;
}

function loadFile() {
  var files = document.getElementById("fileInput").files;
  if(files.length < 1) return;
  var file = files[0];
  var reader = new FileReader();

  reader.onload = function(e) {
    load(reader.result);
  }

  reader.readAsText(file);
}

function setState(accept, reject) {
  machine.setState(accept, reject);
  gui.selectedChanged();
  gui.updateGraph(machine);
}

function setStart() {
  machine.setStart();
  gui.updateGraph(machine);
}

function openFileInput() {
  if (window.File) {
    document.getElementById("fileInput").click();
  } else {
    alert("Sorry, your browser doesn't support the File API. Please load from a string instead.");
  }
}
</script>
</head><body onload="buildGUI()">
<div class="menu">
  <button type="button" onclick="addNode()">Add New State</button>
  <p id="selectedText">Selected states:</p>
  <button type="button" class="acceptButton" onclick="setState(true, false)">Set as Accepting</button>
  <button type="button" class="rejectButton" onclick="setState(false, true)">Set as Rejecting</button>
  <button type="button" class="neitherButton" onclick="setState(false, false)">Set as Neither</button>
  <button type="button" onclick="setStart()">Set as Start</button>
  <button type="button" onclick="deleteSelected()">Delete Selected</button>
  <!--
  TODO: This currently isn't working. The issue appears to be that stylesheets aren't taken into account, 
  but I'm not sure how to fix that. document.styleSheets doesn't seem to be scraping the css properly.
  <button type="button" onclick="downloadAsPng(d3.select('svg'))">Download as PNG</button>
  -->
  <input class="fileInput" id="fileInput" type="file" onchange="loadFile();">
  <button type="button" onclick="openFileInput()">Load</button>
  <!--<button type="button" onclick="loadString()">Load from JSON string</button>-->
  <button type="button" onclick="downloadAsJson(machine.getSaveData(), 'tm.json')">Download as JSON</button>
</div>
<div class="gui"></div>
<div class="sidePanel"></div>

</body></html>
