function run(){var saved=getURLParam("saved"),submit_pset=getURLParam("submit_pset"),submit_problem=getURLParam("submit_problem"),pset=getURLParam("pset"),problem=getURLParam("problem"),charSet=getURLParam("charset"),mode=getURLParam("type"),tapeSet=getURLParam("tapeSet");if(submit_pset&&submit_pset){var submit_pset=parseInt(submit_pset),submit_problem=parseInt(submit_problem);gServer.loadSubmission(submit_pset,submit_problem,function(err,data){if(err)gErrorMenu.displayError("Could not connect to server; load failed",!0);else{var automata=JSON.parse(data[0].automata);reload(automata)}})}else null==saved?buildGraph(pset,problem,charSet,mode,tapeSet):gServer.listSaved(function(err,data){var found=!1;data.forEach(function(elem,index,arr){elem.name===saved&&(found=!0)}),found?gServer.load(saved,function(err,automata){return err?void gErrorMenu.displayError("Could not connect to server; load failed",!0):(gServer.name=saved,void reload(automata))}):gErrorMenu.displayError("Could not connect to server; load failed",!0)})}function reload(automata){var loadedCharSet=automata.meta.charSet,loadedPset=automata.meta.pset,loadedProblem=automata.meta.problem,loadedMode=automata.meta.mode,loadedTapeSet=automata.meta.tapeSet;buildGraph(loadedPset,loadedProblem,loadedCharSet,loadedMode,loadedTapeSet),gGraph.load(automata),gGraph.draw()}function buildGraph(pset,problem,charSet,mode,tapeSet){gBehaviors.init(),gGraph.init(pset,problem,charSet,mode,tapeSet)}function getURLParam(name,url){url||(url=location.href),name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(url);return null==results?null:results[1]}function setURLParam(key,value,url){var re=new RegExp("([?&])"+key+"=.*?(&|$)","i"),separator=-1!==url.indexOf("?")?"&":"?";return url.match(re)?url.replace(re,"$1"+key+"="+value+"$2"):url+separator+key+"="+value}function intersection(str1,str2){for(var result="",i=0;i<str1.length;i++)-1!=str2.indexOf(str1[i])&&(result+=str1[i]);return result}function sortString(str){return str.split("").sort().join("")}function removeDuplicates(str){for(var result="",i=0;i<str.length;i++)-1==result.indexOf(str[i])&&(result+=str[i]);return result}function getURLParent(){var url=window.location.href,loc=url.lastIndexOf("/")+1;return 8>=loc?url+="/":url=url.substring(0,loc),url}function dist(x1,y1,x2,y2){return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2))}function Queue(){var a=[],b=0;this.getLength=function(){return a.length-b},this.isEmpty=function(){return 0==a.length},this.enqueue=function(b){a.push(b)},this.dequeue=function(){if(0!=a.length){var c=a[b];return 2*++b>=a.length&&(a=a.slice(b),b=0),c}},this.peek=function(){return 0<a.length?a[b]:void 0}}var gBehaviors={};gBehaviors.init=function(){gBehaviors.handlers={},gBehaviors.configure("edges",["mousedown","mousemove","mouseup","dblclick"]),gBehaviors.configure("nodes",["mousedown","drag","mouseover","mouseout","mouseup","dblclick"]),gBehaviors.configure("lowerNodes",["mousedown","mousemove","mouseover","mouseout"]),gBehaviors.configure("brush",["brushstart","brush"]),gBehaviors.configure("background",["dblclick","mousemove","mouseover","mouseup","mousedown"]),gBehaviors.configure("page",["keyup","keydown"])},gBehaviors.configure=function(type,events){gBehaviors.handlers[type]={},gBehaviors[type]={},events.forEach(function(event){gBehaviors.handlers[type][event]=[],gBehaviors[type][event]=function(data){gBehaviors.handlers[type][event].forEach(function(entry){entry.condition(data)&&entry.action(data)})}})},gBehaviors.addBehavior=function(type,event,condition,action){gBehaviors.handlers[type][event].push({condition:condition,action:action})},gBehaviors.apply=function(type,selection){for(var event in gBehaviors[type])"drag"===event?selection.call(d3.behavior.drag().on("drag",gBehaviors[type][event]).on("dragstart",function(){gNodes.selectionX=0,gNodes.selectionY=0,gNodes.dragging=!0,gEdges.hideTempEdge()}).on("dragend",function(){gNodes.dragging=!1})):selection.on(event,gBehaviors[type][event])},Math.bound=function(value,min,max){for(var mod=max-min;min>value;)value+=mod;for(;value>max;)value-=mod;return value};var isIE=function(){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE ");if(msie>0)return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10);var trident=ua.indexOf("Trident/");if(trident>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}var edge=ua.indexOf("Edge/");return edge>0?parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10):!1}(),isSafari=function(){var uagent=navigator.userAgent.toLowerCase();return/safari/.test(uagent)&&!/chrome/.test(uagent)}(),psets=[{name:"Problem Set 5",problems:[{name:"1.i",charSet:"abc",type:"dfa"},{name:"1.ii",charSet:"ab",type:"dfa"},{name:"1.iii",charSet:"abcdefghijklmnopqrstuvwxyz",type:"dfa"},{name:"1.iv",charSet:"yd",type:"dfa"},{name:"2.i",charSet:"abc",type:"nfa"},{name:"2.ii",charSet:"abcde",type:"nfa"},{name:"2.iii",charSet:"ab",type:"nfa"}]}],gBrush={};gBrush.init=function(){var brushG=d3.select("g.brush"),brush=d3.svg.brush().x(d3.scale.identity().domain([0,gGraph.width])).y(d3.scale.identity().domain([0,gGraph.height])).clamp([!1,!1]).on("brushend",function(){d3.event.target.clear(),d3.select(this).call(d3.event.target)});gBehaviors.apply("brush",brush),brushG.call(brush),brushG.select(".background").style("cursor","default"),brushG.select(".extent").style("cursor","default")},gGraph.initDelete=function(){gBehaviors.addBehavior("page","keydown",function(){return(46==d3.event.keyCode||8==d3.event.keyCode)&&"none"===d3.select(".overlay").style("display")&&d3.select(".tape-char-input").node()!==document.activeElement&&!gTableTopMenu.active},function(){d3.event.preventDefault(),gNodes.removeNodes()&&(gEdges.deleteSelected(),gGraph.draw())})};var gShiftKey=!1,gEpsilon="∆ê",gGraph={HEIGHT_OFFSET:5,BUFFER:100,DFA:"dfa",NFA:"nfa",TM:"tm"};gGraph.init=function(pset,problem,charSet,mode,tapeSet){var svg=d3.select("svg");gGraph.width=svg.node().getBoundingClientRect().width,gGraph.height=svg.node().getBoundingClientRect().height-gGraph.HEIGHT_OFFSET,gGraph.height-=d3.select(".tape-bar").node().getBoundingClientRect().height,svg.attr("height",gGraph.height);var charSetParam=charSet;gGraph.problem=problem,gGraph.pset=pset,gGraph.mode=mode,gGraph.mode!=gGraph.NFA&&gGraph.mode!=gGraph.TM&&(gGraph.mode=gGraph.DFA),null==charSetParam&&(window.location=getURLParent()+"index.html"),gGraph.charSet=sortString(removeDuplicates(charSetParam)),"tm"===mode&&(gGraph.tapeSet=sortString(removeDuplicates(tapeSet+" "))),gGraph.epsilonEnabled=gGraph.mode==gGraph.NFA,gServer.getSunetid(function(sunetid){gGraph.sunetid=sunetid}),gGraph.mode==gGraph.DFA?d3.selectAll(".dfa-hide").style("display","none"):gGraph.mode==gGraph.NFA?d3.selectAll(".nfa-hide").style("display","none"):(d3.selectAll(".tm-hide").style("display","none"),gGraph.charSet+=" "),gNodes.init(),gEdges.init(),gBrush.init(),gTape.init(),gTestMenu.init(),gModalMenu.initBulk(),gModalMenu.submitModal.init(),gModalMenu.tmEdge.initTmEdit(),gTableMenu.init(),gGraph.initDelete(),gGraph.initCookie(),gSimulator.init(),d3.selectAll(".popup").on("click",function(){d3.event.stopPropagation()}),d3.selectAll(".overlay").on("click",function(){gModalMenu.closeCurrent()}),gBehaviors.addBehavior("page","keydown",function(){return!0},gGraph.keydown),gBehaviors.addBehavior("page","keyup",function(){return!0},gGraph.keyup),gBehaviors.apply("page",d3.select("body")),gBehaviors.apply("background",d3.select("div.gui")),gGraph.draw()},gGraph.keydown=function(){gShiftKey=d3.event.shiftKey||d3.event.metaKey},gGraph.keyup=function(){gShiftKey=d3.event.shiftKey||d3.event.metaKey},gGraph.save=function(){return{nodes:gNodes.save(),edges:gEdges.save(),meta:{charSet:gGraph.charSet,pset:gGraph.pset,problem:gGraph.problem,mode:gGraph.mode,tapeSet:gGraph.tapeSet}}},gGraph.load=function(saveData){gNodes.load(saveData.nodes),gEdges.load(saveData.edges),gTape.reset(),gTestMenu.reset()},gGraph.draw=function(){gNodes.draw(),gEdges.draw(),gTopMenu.draw(),gTableMenu.draw(),gTape.draw()},gGraph.resize=function(){var svg=d3.select("svg");gGraph.width=svg.node().getBoundingClientRect().width,gGraph.height=svg.node().getBoundingClientRect().height,d3.select(".background").attr("width",gGraph.width),d3.select(".background").attr("height",gGraph.height),d3.select(".modal-content").attr("max-height",gGraph.height*gModalMenu.MAX_HEIGHT_PERCENT)},gEdges.initDragging=function(){gEdges.dragging=!1,gEdges.startNode=null,gEdges.backupNode=null,gEdges.endNode=null;var always=function(){return!0};gBehaviors.addBehavior("lowerNodes","mouseover",function(){return!gNodes.dragging},gEdges.showTempEdge),gBehaviors.addBehavior("lowerNodes","mousemove",function(){return!gNodes.dragging},gEdges.drawTempEdge),gBehaviors.addBehavior("lowerNodes","mousedown",always,gEdges.startDragging),gBehaviors.addBehavior("background","mousedown",function(){if(null==gEdges.startNode)return!1;var mouse=d3.mouse(d3.select("svg").node()),dist=Math.sqrt(Math.pow(mouse[0]-gEdges.startNode.x,2)+Math.pow(mouse[1]-gEdges.startNode.y,2));return dist<=gNodes.SELECTABLE_RADIUS&&dist>gNodes.RADIUS},gEdges.startDragging),gBehaviors.addBehavior("nodes","mouseover",function(){return!gEdges.dragging&&gEdges.tempVisible},gEdges.hideTempEdge),gBehaviors.addBehavior("nodes","mouseover",function(){return gEdges.dragging},gEdges.setTempEdgeEnd),gBehaviors.addBehavior("nodes","mouseout",always,gEdges.unsetTempEdgeEnd),gBehaviors.addBehavior("background","mousemove",function(){var mouse=d3.mouse(d3.select("svg").node());if(gEdges.dragging||!gEdges.tempVisible)return!1;var dist=Math.sqrt(Math.pow(mouse[0]-gEdges.startNode.x,2)+Math.pow(mouse[1]-gEdges.startNode.y,2));return dist>gNodes.SELECTABLE_RADIUS},gEdges.hideTempEdge),gBehaviors.addBehavior("edges","mousemove",function(){var mouse=d3.mouse(d3.select("svg").node());if(gEdges.dragging||!gEdges.tempVisible)return!1;var dist=Math.sqrt(Math.pow(mouse[0]-gEdges.startNode.x,2)+Math.pow(mouse[1]-gEdges.startNode.y,2));return dist>gNodes.SELECTABLE_RADIUS},gEdges.hideTempEdge),gBehaviors.addBehavior("background","mousemove",function(){return gEdges.dragging},gEdges.drawTempEdge),gBehaviors.addBehavior("edges","mousemove",function(){return gEdges.dragging},gEdges.drawTempEdge),gBehaviors.addBehavior("edges","mouseup",always,gEdges.hideTempEdge),gBehaviors.addBehavior("background","mouseup",always,gEdges.hideTempEdge),gBehaviors.addBehavior("nodes","mouseup",function(){return gEdges.dragging},gEdges.addTempEdge)},gEdges.unsetTempEdgeEnd=function(endNode){null!=gEdges.endNode&&(gEdges.endNode=null,gGraph.draw())},gEdges.setTempEdgeEnd=function(endNode){gEdges.endNode=endNode,gGraph.draw()},gEdges.addTempEdge=function(endNode){gEdges.endNode=null,gEdges.backupNode=null,gEdges.hideTempEdge();var edge=gEdges.getEdge(gEdges.startNode,endNode);null==edge&&(gEdges.addEdge(gEdges.startNode,endNode),edge=gEdges.edges[gEdges.edges.length-1]),gGraph.draw(),gEdges.editEdge(edge)},gEdges.startDragging=function(){gEdges.dragging=!0},gEdges.hideTempEdge=function(){var mouse=d3.mouse(d3.select("svg").node()),dist=gNodes.SELECTABLE_RADIUS+1;null!=gEdges.backupNode&&(dist=Math.sqrt(Math.pow(mouse[0]-gEdges.backupNode.x,2)+Math.pow(mouse[1]-gEdges.backupNode.y,2))),null==gEdges.backupNode||dist>gNodes.SELECTABLE_RADIUS?(d3.select("path.temp").remove(),gEdges.dragging=!1,gEdges.tempVisible=!1):(gEdges.startNode=gEdges.backupNode,gEdges.dragging=!1,gEdges.drawTempEdge())},gEdges.drawTempEdge=function(){if(null!=gEdges.startNode){if(gNodes.dragging)return d3.select("path.temp").remove(),gEdges.dragging=!1,void(gEdges.tempVisible=!1);var mouse=d3.mouse(d3.select("svg").node());d3.select("path.temp").remove(),gEdges.initialEdge=d3.select(".miscEdges").append("path").classed("temp",!0).style("marker-end","url(#mouse-arrow)").attr("fill","none").attr("d",function(){return null!=gEdges.endNode?gEdges.customPathFunction(gEdges.startNode,gEdges.endNode):gEdges.customPathFunction(gEdges.startNode,{x:mouse[0],y:mouse[1]})}).style("marker-end",function(){return null==gEdges.endNode?"url(#mouse-arrow)":"url(#end-arrow)"})}},gEdges.showTempEdge=function(startNode){gNodes.dragging||(gEdges.dragging?gEdges.backupNode=startNode:(gEdges.startNode=startNode,gEdges.tempVisible=!0,gEdges.drawTempEdge()))};var gEdges={BIDIRECTIONAL_OFFSET:8,LOOP_WIDTH:70,LOOP_HEIGHT:80,LOOP_PEAK:50,LOOP_TEXT_OFFSET:70,TEXT_OFFSET:10,TRANSITION_DY:20,TSPAN_HEIGHT:10,SELECTABLE_WIDTH:25,MARKER_SIZE:30,END_ARROW_OFFSET:36,MOUSE_ARROW_OFFSET:13};gEdges.init=function(){gEdges.lowerG=d3.select("g.edgesLower"),gEdges.upperG=d3.select("g.edges"),gEdges.straightLineFunction=d3.svg.line().x(function(point){return point.x}).y(function(point){return point.y}).interpolate("linear"),gEdges.curvedLineFunction=d3.svg.line().x(function(point){return point.x}).y(function(point){return point.y}).interpolate("basis"),gEdges.lineFunction=function(data){return data[0].x==data[1].x&&data[0].y==data[1].y?gEdges.curvedLineFunction([{x:data[0].x,y:data[0].y},{x:data[0].x+gEdges.LOOP_PEAK,y:data[0].y-gEdges.LOOP_HEIGHT/2},{x:data[0].x+gEdges.LOOP_WIDTH,y:data[0].y},{x:data[0].x+gEdges.LOOP_PEAK,y:data[0].y+gEdges.LOOP_HEIGHT/2},{x:data[0].x,y:data[0].y}]):gEdges.straightLineFunction(data)},gEdges.customPathFunction=function(source,target){var startPoint={x:source.x,y:source.y},endPoint={x:target.x,y:target.y};return target.id!=source.id&&gEdges.areConnected(target.id,source.id)&&(startPoint=gEdges.offsetPoint(startPoint,source,target,gEdges.BIDIRECTIONAL_OFFSET),endPoint=gEdges.offsetPoint(endPoint,source,target,gEdges.BIDIRECTIONAL_OFFSET)),gEdges.lineFunction([startPoint,endPoint])},gEdges.pathFunction=function(edge){return gEdges.customPathFunction(edge.source,edge.target)},gEdges.buildMarker("end-arrow",gEdges.END_ARROW_OFFSET,"black"),gEdges.buildMarker("mouse-arrow",gEdges.MOUSE_ARROW_OFFSET,"black"),gEdges.edges=[],gEdges.edgeMap={},gEdges.initInitial(),gEdges.initSelection(),gEdges.initDragging(),gEdges.initEditing()},gEdges.addEdge=function(source,target){var edge={};edge.source=source,edge.target=target,edge.transitions=[[]],gEdges.edges.push(edge),gEdges.edgeMap[source.id].push(target.id)},gEdges.removeEdge=function(source,target){gEdges.edges=gEdges.edges.filter(function(edge){return edge.source.id!=source.id||edge.target.id!=target.id});var index=gEdges.edgeMap[source.id].indexOf(target.id);gEdges.edgeMap[source.id].splice(index,1)},gEdges.addNode=function(node){gEdges.edgeMap[node.id]=[]},gEdges.removeNode=function(node){node.id==gEdges.startNode.id&&(gEdges.startNode=null,gEdges.hideTempEdge()),gEdges.edges=gEdges.edges.filter(function(edge){return edge.source.id!=node.id&&edge.target.id!=node.id});for(var sourceId in gEdges.edgeMap){var index=gEdges.edgeMap[sourceId].indexOf(node.id);gEdges.edgeMap[sourceId].splice(index,1)}delete gEdges.edgeMap[node.id]},gEdges.save=function(){var saveData={edgeMap:JSON.parse(JSON.stringify(gEdges.edgeMap)),edges:JSON.parse(JSON.stringify(gEdges.edges))};return saveData.edges.forEach(function(edge){edge.source=edge.source.id,edge.target=edge.target.id}),saveData},gEdges.load=function(saveData){gEdges.edges=saveData.edges,gEdges.edgeMap=saveData.edgeMap,gEdges.edges.forEach(function(edge){edge.source=gNodes.nodes[gNodes.getNodeIndex(edge.source)],edge.target=gNodes.nodes[gNodes.getNodeIndex(edge.target)]})},gEdges.createDOMEdges=function(lowerSelection,upperSelection){gBehaviors.apply("edges",lowerSelection.append("path").attr("fill","none").classed("lower",!0).classed("transparent",!0)),upperSelection=upperSelection.append("g"),gBehaviors.apply("edges",upperSelection),upperSelection.append("path").attr("fill","none").classed("edge",!0),upperSelection.append("text")},gEdges.drawDOMEdges=function(lowerSelection,upperSelection){lowerSelection.attr("d",gEdges.pathFunction),upperSelection.select("path").attr("d",gEdges.pathFunction).classed("selected",function(edge){return edge.selected}).style("marker-end",function(edge){return edge.selected?"url(#sel-arrow)":"url(#end-arrow)"});var tspans=upperSelection.select("text").selectAll("tspan").data(function(edge){return gGraph.mode==gGraph.TM?edge.transitions[0]:edge.transitions});tspans.enter().append("tspan"),tspans.text(gEdges.getEdgeLabel).attr("x",function(d,i2,i1){var actualEdge;return d3.select(this.parentNode).each(function(edge,i){actualEdge=edge}),gEdges.getTextPosition(actualEdge.source,actualEdge.target,this.parentNode.getBoundingClientRect()).x}).attr("dy",gEdges.TRANSITION_DY),upperSelection.select("text").attr("x",function(edge){return gEdges.getTextPosition(edge.source,edge.target,this.getBoundingClientRect()).x}).attr("y",function(edge){var tspanCount=d3.select(this).selectAll("tspan").size()-1;return gEdges.getTextPosition(edge.source,edge.target,this.getBoundingClientRect()).y+tspanCount*gEdges.TSPAN_HEIGHT}),tspans.exit().remove(),gEdges.drawInitial()},gEdges.destroyDOMEdges=function(lowerSelection,upperSelection){lowerSelection.remove(),upperSelection.remove()},gEdges.draw=function(){isIE&&(gEdges.lowerG.selectAll("path").remove(),gEdges.upperG.selectAll("g").remove());var lowerEdges=gEdges.lowerG.selectAll("path").data(gEdges.edges,gEdges.getEdgeId),upperEdges=gEdges.upperG.selectAll("g").data(gEdges.edges,gEdges.getEdgeId);gEdges.createDOMEdges(lowerEdges.enter(),upperEdges.enter()),gEdges.drawDOMEdges(lowerEdges,upperEdges),gEdges.destroyDOMEdges(lowerEdges.exit(),upperEdges.exit())},gEdges.areConnected=function(sourceId,targetId){return null!=gEdges.endNode&&sourceId==gEdges.startNode.id&&targetId==gEdges.endNode.id||gEdges.edgeMap[sourceId]&&gEdges.edgeMap[sourceId].indexOf(targetId)>-1},gEdges.getEdgeLabel=function(transition){if(gGraph.mode==gGraph.TM){var from=" "==transition.from?gSquare:transition.from,to=" "==transition.to?gSquare:transition.to;return from+String.fromCharCode(8594)+to+", "+(1==transition.direction?"R":"L")}return gEdges.reduceLabel(transition)},gEdges.reduceLabel=function(transition){var charSet=gGraph.charSet,text="";return charSet.length/2>=transition.length?(transition.forEach(function(symbol){text+=symbol+", "}),0!=text.length&&(text=text.substring(0,text.length-2))):(text="Œ£ - ",charSet.split("").forEach(function(symbol){-1==transition.indexOf(symbol)&&(text+=symbol+", ")}),text=6!=text.length?text.substring(0,text.length-2):"Œ£",-1!=transition.indexOf(gEpsilon)&&(text+=" + "+gEpsilon)),text},gEdges.getEdgeId=function(edge){return edge.source.id+" "+edge.target.id},gEdges.getEdge=function(source,target){var targetEdge=null;return gEdges.edges.forEach(function(edge){edge.source.id==source.id&&edge.target.id==target.id&&(targetEdge=edge)}),targetEdge},gEdges.buildMarker=function(id,refX,fill){d3.select("svg").append("svg:defs").append("svg:marker").attr("id",id).attr("viewBox","0 -50 100 100").attr("refX",refX).attr("markerWidth",gEdges.MARKER_SIZE).attr("markerHeight",gEdges.MARKER_SIZE).attr("orient","auto").append("svg:path").attr("d","M 0,-5 L 10,0 L 0,5 z").attr("fill",fill).attr("stroke",fill).style("pointer-events","none")},gEdges.getTextPosition=function(source,target,bbox){var startPoint={x:source.x,y:source.y},endPoint={x:target.x,y:target.y};target.id==source.id?(startPoint.x+=gEdges.LOOP_TEXT_OFFSET,startPoint.y-=1,endPoint.x+=gEdges.LOOP_TEXT_OFFSET,endPoint.y+=1):gEdges.areConnected(target.id,source.id)&&(startPoint=gEdges.offsetPoint(startPoint,source,target,gEdges.BIDIRECTIONAL_OFFSET),endPoint=gEdges.offsetPoint(endPoint,source,target,gEdges.BIDIRECTIONAL_OFFSET));var midpoint={x:(startPoint.x+endPoint.x)/2,y:(startPoint.y+endPoint.y)/2},theta=Math.bound(Math.atan2(startPoint.y-endPoint.y,startPoint.x-endPoint.x)+Math.PI/2,0,2*Math.PI),dist=Math.sqrt(Math.pow(bbox.height/2,2)+Math.pow(bbox.width/2,2)),hc=theta>Math.PI?-1:1,wc=theta<3*Math.PI/2&&theta>=Math.PI/2?-1:1,dtheta=Math.bound(Math.atan2(hc*bbox.height,wc*bbox.width),0,2*Math.PI),ttheta=Math.abs(dtheta-theta),q=Math.cos(ttheta)*dist;return q+=gEdges.TEXT_OFFSET,{x:midpoint.x+Math.cos(theta)*q,y:midpoint.y-bbox.height+Math.sin(theta)*q}},gEdges.offsetPoint=function(point,orig,perp,distance){var angle=Math.atan2(orig.y-perp.y,orig.x-perp.x),rotatedAngle=angle+Math.PI/2;return{x:point.x+Math.cos(rotatedAngle)*distance,y:point.y+Math.sin(rotatedAngle)*distance}},gEdges.initEditing=function(){gEdges.editedEdge=null,gBehaviors.addBehavior("edges","dblclick",function(){return!0},gEdges.editEdge),d3.select(".edgeChars").on("keypress",function(){13==d3.event.keyCode&&gModalMenu.submit("edgeEntry")})},gEdges.populateTMEdgeModal=function(edge){d3.select(".tmEdgeEntry").select(".modal-header").text("Edit Transition "+edge.source.name+" "+String.fromCharCode(8594)+" "+edge.target.name);for(var states=JSON.parse(JSON.stringify(gEdges.editedEdge.transitions[0])),i=0;i<states.length;i++)" "==states[i].from&&(states[i].from="")," "==states[i].to&&(states[i].to="");gModalMenu.tmEdge.setTmEdgeStates(states)},gEdges.populateEdgeModal=function(edge){var chars=edge.transitions[0].join(""),epsilon=chars.length>0&&chars[chars.length-1]==gEpsilon;epsilon&&(chars=chars.substring(0,chars.length-1)),gModalMenu.setEdgeChars(chars),gModalMenu.setEpsilon(epsilon)},gEdges.editEdge=function(edge){gEdges.editedEdge=edge,gGraph.mode==gGraph.TM?(gEdges.populateTMEdgeModal(edge),gModalMenu.open("tmEdgeEntry")):(gEdges.populateEdgeModal(edge),gModalMenu.open("edgeEntry")),gModalMenu.open(gGraph.mode==gGraph.TM?"tmEdgeEntry":"edgeEntry"),d3.event.stopPropagation()},gEdges.editCancelled=function(){0==gEdges.editedEdge.transitions[0].length&&gEdges.removeEdge(gEdges.editedEdge.source,gEdges.editedEdge.target),gEdges.editedEdge=null,gModalMenu.close(gGraph.mode==gGraph.TM?"tmEdgeEntry":"edgeEntry"),gGraph.draw()},gEdges.deleteEditedEdge=function(){gEdges.removeEdge(gEdges.editedEdge.source,gEdges.editedEdge.target),gEdges.editedEdge=null,gModalMenu.close(gGraph.mode==gGraph.TM?"tmEdgeEntry":"edgeEntry"),gGraph.draw()},gEdges.tmEditComplete=function(){for(var states=gModalMenu.tmEdge.getTmEdgeStates(),charsUsed="",emptyUsed=!1,i=0;i<states.length;i++){if(""==states[i].to&&(states[i].to=" "),""==states[i].from){if(states[i].from=" ",emptyUsed)return void gErrorMenu.displayModalError("tmEdgeEntry","Only one transition can be defined for blank");emptyUsed=!0}else if(-1!=charsUsed.indexOf(states[i].from))return void gErrorMenu.displayModalError("tmEdgeEntry","Only one transition can be defined for character "+states[i].from);if(charsUsed+=states[i].from,1!=intersection(states[i].to,gGraph.tapeSet).length||1!=intersection(states[i].from,gGraph.tapeSet).length)return void gErrorMenu.displayModalError("tmEdgeEntry","Please only use characters in the character set")}if(0==states.length)return void gErrorMenu.displayModalError("tmEdgeEntry","You must define at least one transition");for(var i=0;i<gEdges.edges.length;i++){var edge=gEdges.edges[i];if(edge.source.id==gEdges.editedEdge.source.id&&edge.target.id!=gEdges.editedEdge.target.id){for(var k=0;k<states.length;k++)for(var j=0;j<edge.transitions[0].length;j++)states[k].from==edge.transitions[0][j].from&&edge.transitions[0].splice(j--,1);0==edge.transitions[0].length&&gEdges.removeEdge(edge.source,edge.target)}}gEdges.editedEdge.transitions[0]=states,gEdges.editedEdge=null,gModalMenu.close("tmEdgeEntry"),gGraph.draw(),gGraph.draw()},gEdges.editComplete=function(){var chars=removeDuplicates(gModalMenu.getEdgeCharacters().replace(/[\s,]/g,"")),legal=intersection(gGraph.charSet,chars),oldChars=chars;if(chars=legal,gModalMenu.setEdgeChars(legal),chars+=gModalMenu.getEpsilon()?gEpsilon:"",legal.length!=oldChars.length&&(0==chars.length?gErrorMenu.displayModalError("edgeEntry","Ignoring characters that aren't in the alphabet."):gErrorMenu.displayError("Ignoring characters that aren't in the alphabet.")),0==chars.length)return void gErrorMenu.displayModalError("edgeEntry","Transitions must take at least one character");var transitions=chars.split("");transitions.sort();for(var i=0;i<transitions.length-1;i++)transitions[i]==transitions[i+1]&&transitions.splice(i--,1);if(gGraph.mode==gGraph.DFA){var removed=!1;transitions.forEach(function(transition){for(var i=0;i<gEdges.edges.length;i++){var edge=gEdges.edges[i];if(edge!=gEdges.editedEdge&&edge.source==gEdges.editedEdge.source){var index=edge.transitions[0].indexOf(transition);-1!=index&&(edge.transitions[0].splice(index,1),0==edge.transitions[0].length&&(gEdges.removeEdge(edge.source,edge.target),i--,removed=!0))}}}),removed&&gErrorMenu.displayError("Removed duplicate transitions")}gEdges.editedEdge.transitions[0]=transitions,gEdges.editedEdge=null,gModalMenu.close("edgeEntry"),gGraph.draw()},gEdges.INITIAL_EDGE_LENGTH=60,gEdges.INITIAL_OVERLAP_RANGE=7,gEdges.INITIAL_OVERLAP_ANGLE=20,gEdges.initInitial=function(){d3.select(".miscEdges").append("path").classed("initial",!0).style("marker-end","url(#end-arrow)").attr("fill","none")},gEdges.drawInitial=function(){var initialNode=gNodes.initial;if(null==initialNode)d3.select("path.initial").style("opacity",0);else{var yOffset=0,xOffset=gEdges.INITIAL_EDGE_LENGTH;gEdges.edges.forEach(function(edge){var lx=Math.min(edge.source.x,edge.target.x),rx=Math.max(edge.source.x,edge.target.x);if(initialNode.x<=rx&&initialNode.x-gEdges.INITIAL_EDGE_LENGTH>=lx&&edge.target.x-edge.source.x!=0){var m=(edge.target.y-edge.source.y)/(edge.target.x-edge.source.x),b=edge.source.y-m*edge.source.x,ly=m*(initialNode.x-gEdges.INITIAL_EDGE_LENGTH)+b,ry=m*initialNode.x+b;Math.abs(ly-initialNode.y)<=gEdges.INITIAL_OVERLAP_RANGE&&Math.abs(ry-initialNode.y)<=gEdges.INITIAL_OVERLAP_RANGE&&(xOffset=Math.cos(Math.PI/180*gEdges.INITIAL_OVERLAP_ANGLE)*gEdges.INITIAL_EDGE_LENGTH,yOffset=Math.sin(Math.PI/180*gEdges.INITIAL_OVERLAP_ANGLE)*gEdges.INITIAL_EDGE_LENGTH,ry>ly&&(yOffset*=-1))}}),d3.select("path.initial").style("opacity",1).attr("d",function(){return gEdges.lineFunction([{x:initialNode.x-xOffset,y:initialNode.y-yOffset},{x:initialNode.x,y:initialNode.y}])})}},isIE&&(gEdges.initInitial=function(){},gEdges.drawInitial=function(){d3.select("path.initial").remove();var initialNode=gNodes.initial;null!=initialNode&&d3.select(".miscEdges").append("path").classed("initial",!0).style("marker-end","url(#end-arrow)").attr("fill","none").attr("d",function(){return gEdges.lineFunction([{x:initialNode.x-gEdges.INITIAL_EDGE_LENGTH,y:initialNode.y},{x:initialNode.x,y:initialNode.y}])})}),gEdges.SELECTED_COLOR="blue",gEdges.initSelection=function(){gEdges.buildMarker("sel-arrow",gEdges.END_ARROW_OFFSET,gEdges.SELECTED_COLOR),gBehaviors.addBehavior("edges","mousedown",function(){return!0},function(edge){gShiftKey||edge.selected||(gNodes.deselectAll(),gEdges.deselectAll()),edge.selected=!0,gGraph.draw()})},gEdges.deleteSelected=function(){var selected=[];gEdges.edges.forEach(function(edge){edge.selected&&selected.push(edge)}),selected.forEach(function(edge){gEdges.removeEdge(edge.source,edge.target)})},gEdges.deselectAll=function(){gEdges.edges.forEach(function(edge){edge.selected=!1})},gEdges.selectionIsEmpty=function(){return 0==gEdges.selectionSize()},gEdges.selectionSize=function(){return gEdges.edges.filter(function(edge){return edge.selected}).length},gNodes.doubleClickInit=function(){gBehaviors.addBehavior("background","dblclick",function(){return!gTableTopMenu.active},function(){var mouse=d3.mouse(d3.select("svg").node());gNodes.addNode(mouse[0],mouse[1]),gNodes.draw()})},gNodes.editInit=function(){gNodes.editedNode=null,gBehaviors.addBehavior("nodes","dblclick",function(){return!0},gNodes.editNode),d3.select(".nodeName").on("keypress",function(){13==d3.event.keyCode&&gModalMenu.submit("nodeEntry")})},gNodes.editNode=function(node){gNodes.editedNode=node,gModalMenu.setNodeName(node.name),gModalMenu.setInitial(null!=gNodes.initial&&node.id==gNodes.initial.id),gModalMenu.setState(node.accept,node.reject),gModalMenu.open("nodeEntry"),d3.event.stopPropagation()},gNodes.editComplete=function(){var name=gModalMenu.getNodeName();if(0==name.replace(/\s/g,"").length)return void gErrorMenu.displayModalError("nodeEntry","State name cannot be blank.");var index=gNodes.getNodeIndexFromName(name);-1==index||gNodes.nodes[index].id==gNodes.editedNode.id?(gNodes.editedNode.accept=gModalMenu.getAccepting(),gNodes.editedNode.reject=gModalMenu.getRejecting(),gModalMenu.getInitial()?gNodes.initial=gNodes.editedNode:null!=gNodes.initial&&gNodes.editedNode.id==gNodes.initial.id&&(gNodes.initial=null),gNodes.editedNode.name=name,gNodes.editedNode=null,gModalMenu.close("nodeEntry"),gGraph.draw()):gErrorMenu.displayModalError("nodeEntry",'State name "'+name+'" is already in use.')},gNodes.deleteEdited=function(){if(null!=gTape.follow&&gTape.follow.id==gNodes.editedNode.id){if(!gTape.done)return void gErrorMenu.displayModalError("nodeEntry","The current state in a running test cannot be deleted");gTestMenu.end()}gNodes.removeByIndex(gNodes.getNodeIndex(gNodes.editedNode.id)),gModalMenu.close("nodeEntry"),gGraph.draw()},gNodes.FORCE_LAYOUT_ITERATIONS=1e5,gNodes.forcedDirectedLayout=function(){var nodes=[];gNodes.nodes.forEach(function(node){nodes.push({x:node.x,y:node.y,vx:0,vy:0})});var edges=[];gEdges.edges.forEach(function(edge){edges.push({source:gNodes.getNodeIndex(edge.source.id),target:gNodes.getNodeIndex(edge.target.id)})});var force=d3.layout.force().nodes(nodes).links(edges).linkDistance(200).charge(-300).gravity(.01).size([gGraph.width-2*gGraph.BUFFER,gGraph.height-2*gGraph.BUFFER]);force.start();for(var i=0;i<gNodes.FORCE_LAYOUT_ITERATIONS;i++)force.tick();force.stop();for(var i=0;i<nodes.length;i++)gNodes.nodes[i].x=nodes[i].x,gNodes.nodes[i].y=nodes[i].y;gNodes.scale()},gNodes.moveSelected=function(dx,dy){dx+=gNodes.selectionX,dy+=gNodes.selectionY,gNodes.selectionX=0,gNodes.selectionY=0;var nodeIsSelected=function(node){return node.selected},edgeIsSelected=function(edge){return edge.source.selected||edge.target.selected};if(gNodes.validMoveX(dx)?gNodes.nodes.filter(nodeIsSelected).forEach(function(node){node.x+=dx}):gNodes.selectionX+=dx,gNodes.validMoveY(dy)?gNodes.nodes.filter(nodeIsSelected).forEach(function(node){node.y+=dy}):gNodes.selectionY+=dy,isIE)gGraph.draw();else{var upperG=d3.select("g.nodes").selectAll("g").filter(nodeIsSelected),lowerG=d3.select("g.nodesLower").selectAll("circle").filter(nodeIsSelected);gNodes.drawDOMNodes(lowerG,upperG),upperG=d3.select("g.edges").selectAll("g").filter(edgeIsSelected),lowerG=d3.select("g.edgesLower").selectAll("path").filter(edgeIsSelected),gEdges.drawDOMEdges(lowerG,upperG),gEdges.drawInitial(),gTape.draw()}},gNodes.movementInit=function(){gBehaviors.addBehavior("nodes","drag",function(node){return node.selected},function(node){gNodes.moveSelected(d3.event.dx,d3.event.dy)})};var gNodes={SELECTABLE_RADIUS:50,RADIUS:30,INNER_RADIUS:24,STROKE_WIDTH:2,NEW_BUFFER:100,NEW_INCREMENT:100,IE_TEXT_OFFSET:5};gNodes.init=function(){gNodes.lowerG=d3.select("g.nodesLower"),gNodes.upperG=d3.select("g.nodes"),gNodes.nodes=[],gNodes.initial=null,gNodes.selectionInit(),gNodes.movementInit(),gNodes.doubleClickInit(),gNodes.editInit()},gNodes.setInitial=function(){var selected=gNodes.nodes.filter(function(node){return node.selected});selected.length>0&&(gNodes.initial=selected[0])},gNodes.setAccepting=function(accepting){gNodes.nodes.filter(function(node){return node.selected}).forEach(function(node){node.accept=accepting})},gNodes.setRejecting=function(rejecting){gNodes.nodes.filter(function(node){return node.selected}).forEach(function(node){node.reject=rejecting})},gNodes.wouldOverlap=function(x,y){var overlaps=!1;return gNodes.nodes.forEach(function(node){overlaps|=dist(x,y,node.x,node.y)<=2*gNodes.RADIUS}),overlaps},gNodes.addNode=function(x,y){var node={};if("undefined"==typeof x){var foundPosition=!1;for(node.y=gNodes.NEW_BUFFER;node.y<=gGraph.height-gNodes.NEW_BUFFER&&!foundPosition;node.y+=gNodes.NEW_INCREMENT)for(node.x=gNodes.NEW_BUFFER;node.x<=gGraph.width-gNodes.NEW_BUFFER&&!foundPosition;node.x+=gNodes.NEW_INCREMENT)foundPosition=!gNodes.wouldOverlap(node.x,node.y);
node.x-=gNodes.NEW_INCREMENT,node.y-=gNodes.NEW_INCREMENT}else node.x=x,node.y=y;for(var nextId=0;-1!=gNodes.getNodeIndexFromName("n"+nextId);)nextId++;node.id=nextId,node.name="n"+node.id,node.accept=!1,node.reject=!1,node.selected=!0,gNodes.deselectAll(),gNodes.nodes.push(node),gEdges.addNode(node)},gNodes.setInitialByIndex=function(index){gNodes.initial=gNodes.nodes[index]},gNodes.clearInitial=function(){gNodes.initial=null},gNodes.setAcceptByIndex=function(index,accept){gNodes.nodes[index].accept=accept},gNodes.setRejectByIndex=function(index,reject){gNodes.nodes[index].reject=reject},gNodes.removeByIndex=function(index){null!=gTape.follow&&gTape.follow.id==gNodes.nodes[index].id&&gTestMenu.end(),null!=gNodes.initial&&gNodes.initial.id==gNodes.nodes[index].id&&(gNodes.initial=null),gEdges.removeNode(gNodes.nodes[index]),gNodes.nodes.splice(index,1)},gNodes.removeNodes=function(){if(null!=gTape.follow&&gTape.follow.selected){if(!gTape.done)return gErrorMenu.displayError("The current state in a running test cannot be deleted"),!1;gTestMenu.end()}for(var i=0;i<gNodes.nodes.length;i++)gNodes.nodes[i].selected&&(null!=gNodes.initial&&gNodes.initial.id==gNodes.nodes[i].id&&(gNodes.initial=null),gEdges.removeNode(gNodes.nodes[i]),gNodes.nodes.splice(i--,1));return!0},gNodes.createDOMNodes=function(lowerSelection,upperSelection){gBehaviors.apply("lowerNodes",lowerSelection.append("circle").classed("transparent",!0).attr("r",gNodes.SELECTABLE_RADIUS)),upperSelection=upperSelection.append("g"),gBehaviors.apply("nodes",upperSelection.append("circle").classed("outer",!0).attr("r",gNodes.RADIUS)),gBehaviors.apply("nodes",upperSelection.append("circle").classed("inner",!0).attr("r",gNodes.INNER_RADIUS)),upperSelection.append("text")},gNodes.getSelected=function(){var selected=[];return gNodes.nodes.forEach(function(node){node.selected&&selected.push(node.name)}),selected},gNodes.save=function(){return{nodes:gNodes.nodes,initial:null==gNodes.initial?null:gNodes.initial.id}},gNodes.load=function(saveData){gNodes.nodes=saveData.nodes,gNodes.initial=saveData.initial,null!=gNodes.initial&&(gNodes.initial=gNodes.nodes[gNodes.getNodeIndex(gNodes.initial)]),gNodes.nextId=0,gNodes.nodes.forEach(function(node){gNodes.nextId=Math.max(node.id+1,gNodes.nextId)}),gNodes.scale()},gNodes.scale=function(){if(gNodes.nodes.length>0){for(var xMin=gNodes.nodes[0].x,xMax=gNodes.nodes[0].x,yMin=gNodes.nodes[0].y,yMax=gNodes.nodes[0].y,i=1;i<gNodes.nodes.length;i++)xMin=Math.min(xMin,gNodes.nodes[i].x),xMax=Math.max(xMax,gNodes.nodes[i].x),yMin=Math.min(yMin,gNodes.nodes[i].y),yMax=Math.max(yMax,gNodes.nodes[i].y);var leftBound=xMin,rightBound=xMax;(gGraph.BUFFER>xMin||gGraph.width-gGraph.BUFFER<xMax)&&(leftBound=gGraph.BUFFER,rightBound=gGraph.width-gGraph.BUFFER);var topBound=yMin,bottomBound=yMax;(gGraph.BUFFER>yMin||gGraph.height-gGraph.BUFFER<yMax)&&(topBound=gGraph.BUFFER,bottomBound=gGraph.height-gGraph.BUFFER);for(var i=0;i<gNodes.nodes.length;i++){var xDenom=xMax-xMin,xPercent=0==xDenom?1:(gNodes.nodes[i].x-xMin)/xDenom,yDenom=yMax-yMin,yPercent=0==yDenom?1:(gNodes.nodes[i].y-yMin)/yDenom;gNodes.nodes[i].x=leftBound*(1-xPercent)+rightBound*xPercent,gNodes.nodes[i].y=topBound*(1-yPercent)+bottomBound*yPercent}}},gNodes.selectionIsAccepting=function(){var accepting=!0,selectionExists=!1;return gNodes.nodes.forEach(function(node){node.selected&&(selectionExists=!0,node.selected&&!node.accept&&(accepting=!1))}),accepting&&selectionExists},gNodes.selectionIsRejecting=function(){var rejecting=!0,selectionExists=!1;return gNodes.nodes.forEach(function(node){node.selected&&(selectionExists=!0,node.selected&&!node.reject&&(rejecting=!1))}),rejecting&&selectionExists},gNodes.selectionIsNeither=function(){var neither=!0,selectionExists=!1;return gNodes.nodes.forEach(function(node){node.selected&&(selectionExists=!0,(node.accept||node.reject)&&(neither=!1))}),neither&&selectionExists},gNodes.drawDOMNodes=function(lowerSelection,upperSelection){lowerSelection.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}),upperSelection.classed("selected",function(d){return d.selected}).classed("accept",function(d){return d.accept}).classed("reject",function(d){return d.reject}),upperSelection.select("circle.inner").attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}),upperSelection.select("circle.outer").attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}),upperSelection.select("text").text(function(d){return d.name}).attr("x",function(d){return d.x}).attr("y",function(d){return d.y+(isIE?gNodes.IE_TEXT_OFFSET:0)})},gNodes.destroyDOMNodes=function(lowerSelection,upperSelection){lowerSelection.remove(),upperSelection.remove()},gNodes.draw=function(){if(isIE&&(gNodes.lowerG.selectAll("circle").remove(),gNodes.upperG.selectAll("g").remove()),gNodes.upperG.select(".empty-text").remove(),0==gNodes.nodes.length){var emptyText=isSafari?"Click Add New State to create your first node.":"Double-click to create your first node.";gNodes.upperG.append("text").classed("empty-text",!0).style("font-size",20).style("font-family",'"San Francisco", "Helvetica Neue", "Helvetica", "Arial", sans-serif').style("fill","rgba(0, 0, 0, 0.4)").style("stroke","none").attr("x",gGraph.width/2).attr("y",gGraph.height/2).text(emptyText)}var lowerNodes=gNodes.lowerG.selectAll("circle").data(gNodes.nodes,function(d){return d.id}),upperNodes=gNodes.upperG.selectAll("g").data(gNodes.nodes,function(d){return d.id});gNodes.createDOMNodes(lowerNodes.enter(),upperNodes.enter()),gNodes.drawDOMNodes(lowerNodes,upperNodes),gNodes.destroyDOMNodes(lowerNodes.exit(),upperNodes.exit())},gNodes.validMoveX=function(dx){var valid=!0;return gNodes.nodes.filter(function(node){return node.selected}).forEach(function(node){valid&=node.x+dx>=gNodes.RADIUS+gNodes.STROKE_WIDTH||dx>=0,valid&=node.x+dx<=gGraph.width-gNodes.RADIUS-gNodes.STROKE_WIDTH||0>=dx}),valid},gNodes.validMoveY=function(dy){var valid=!0;return gNodes.nodes.filter(function(node){return node.selected}).forEach(function(node){valid&=node.y+dy>=gNodes.RADIUS+gNodes.STROKE_WIDTH||dy>=0,valid&=node.y+dy<=gGraph.height-gNodes.RADIUS-gNodes.STROKE_WIDTH||0>=dy}),valid},gNodes.getNodeIndex=function(id){var index=-1;return gNodes.nodes.forEach(function(node,i){node.id==id&&(index=i)}),index},gNodes.getNodeIndexFromName=function(name){var index=-1;return gNodes.nodes.forEach(function(node,i){node.name===name&&(index=i)}),index},gNodes.select=function(id){gNodes.nodes[gNodes.getNodeIndex(id)].selected=!0},gNodes.deselect=function(id){gNodes.nodes[gNodes.getNodeIndex(id)].selected=!1},gNodes.toggleSelection=function(id){gNodes.nodes[gNodes.getNodeIndex(id)].selected^=!0},gNodes.deselectAll=function(){gNodes.nodes.forEach(function(node){node.selected=!1})},gNodes.selectionIsEmpty=function(){return 0==gNodes.selectionSize()},gNodes.selectionSize=function(){return gNodes.nodes.filter(function(node){return node.selected}).length},gNodes.selectionInit=function(){gBehaviors.addBehavior("nodes","mousedown",function(){return!0},function(node){gShiftKey||node.selected||(gNodes.deselectAll(),gEdges.deselectAll()),node.selected=!0,gGraph.draw()}),gBehaviors.addBehavior("brush","brushstart",function(){return!0},function(){gNodes.nodes.forEach(function(node){node.previouslySelected=gShiftKey&&node.selected}),gEdges.deselectAll()}),gBehaviors.addBehavior("brush","brush",function(){return!0},function(){var extent=d3.event.target.extent();gNodes.nodes.forEach(function(node){node.selected=node.previouslySelected^(extent[0][0]<=node.x&&node.x<extent[1][0]&&extent[0][1]<=node.y&&node.y<extent[1][1])}),gGraph.draw()})},gNodes.GRID_SPACING=150,gNodes.snapToGrid=function(){for(var points=[],x=gNodes.GRID_SPACING;x<=gGraph.width-gNodes.GRID_SPACING;x+=gNodes.GRID_SPACING)for(var y=gNodes.GRID_SPACING;y<=gGraph.height-gNodes.GRID_SPACING;y+=gNodes.GRID_SPACING)points.push({x:x,y:y});var nodes=[],initial=-1;if(gNodes.nodes.forEach(function(node,i){null!=gNodes.initial&&gNodes.initial.id==node.id&&(initial=i),nodes.push({x:node.x,y:node.y,i:i})}),!(points.length<nodes.length))for(;nodes.length>0&&points.length>0;){for(var bestDist=-1,bestPoint=-1,bestNode=-1,i=0;i<nodes.length;i++)for(var j=0;j<points.length;j++){var dist=Math.pow(nodes[i].x-points[j].x,2)+Math.pow(nodes[i].y-points[j].y,2);(-1==bestNode||bestDist>dist)&&(bestPoint=j,bestNode=i,bestDist=dist)}gNodes.nodes[nodes[bestNode].i].x=points[bestPoint].x,gNodes.nodes[nodes[bestNode].i].y=points[bestPoint].y,nodes.splice(bestNode,1),points.splice(bestPoint,1)}};var gErrorMenu={DISPLAY_TIME:2100,FADE_OUT_TIME:400,MAX_ERRORS:3};gErrorMenu.displayMessage=function(message,persistent,className){var selection=d3.select(".errors").append("span").text(message).classed(className,!0);1!=persistent&&selection.transition().delay(gErrorMenu.DISPLAY_TIME).duration(gErrorMenu.FADE_OUT_TIME).ease("cubic").style("opacity",0).remove();var errors=d3.select(".errors").selectAll("span").size();d3.select(".errors").selectAll("span").filter(function(junk,i){return i<errors-gErrorMenu.MAX_ERRORS}).remove()},gErrorMenu.displayError=function(message,persistent){gErrorMenu.displayMessage(message,persistent,"error")},gErrorMenu.displayModalError=function(modal,message){d3.select("."+modal).select(".modal-content").insert("p",":first-child").classed("modal-description",!0).classed("error",!0).text(message)},gErrorMenu.clearModalErrors=function(){d3.selectAll(".modal-description.error").remove()};var gTableMenu={};gTableMenu.updateAll=function(){var charSet=gGraph.charSet;gGraph.epsilonEnabled&&(charSet+=gEpsilon),gGraph.mode==gGraph.TM&&(charSet=gGraph.tapeSet),charSet=charSet.split(""),gEdges.edges=[];var map=[];gNodes.nodes.forEach(function(node){gEdges.edgeMap[node.id]=[];var arr=[];gNodes.nodes.forEach(function(){arr.push(gGraph.mode==gGraph.TM?{}:"")}),map.push(arr)});var extraNames=!1,badNames=!1,badChars=!1;d3.selectAll("input.gridInput").each(function(junk,i){var isName=i%2==0||gGraph.mode!=gGraph.TM,character=this.character,i1=this.i1;if(isName){var nodes=this.value.split(/[ \t\n\r,]/),foundOne=!1;nodes.forEach(function(nodeName){var nodeIndex=gNodes.getNodeIndexFromName(nodeName);-1!=nodeIndex?(foundOne&&gGraph.mode!=gGraph.NFA?extraNames=!0:gGraph.mode==gGraph.TM?map[i1][nodeIndex][character]={from:character}:map[i1][nodeIndex]+=character,foundOne=!0):""!=nodeName&&(badNames=!0)})}else{var to=this.value;if(intersection(to,gGraph.tapeSet).length!=to.length)return void(badChars=!0);var nodeIndex=-1;for(var prop in map[i1])if(void 0!=map[i1][prop][character]){nodeIndex=prop;break}-1!=nodeIndex&&void 0!=map[i1][nodeIndex][character]&&(map[i1][nodeIndex][character].to=""==to?" ":to)}}),d3.selectAll(".moveRight").each(function(){var character=this.character,i1=this.i1,direction=this.checked?1:-1,nodeIndex=-1;for(var prop in map[i1])if(void 0!=map[i1][prop][character]){nodeIndex=prop;break}-1!=nodeIndex&&void 0!=map[i1][nodeIndex][character]&&(map[i1][nodeIndex][character].direction=direction)}),extraNames&&gErrorMenu.displayError("Multiple transitions defined for one character, ignoring extras"),badNames&&gErrorMenu.displayError("Some states entered in the table could not be found, ignoring them"),badChars&&gErrorMenu.displayError("Some characters were not in the tape language"),map.forEach(function(row,i1){row.forEach(function(transitions,i2){var transitionsArray=[];if(gGraph.mode==gGraph.TM)for(var prop in transitions)transitionsArray.push(transitions[prop]);if(""!=transitions&&(gGraph.mode!=gGraph.TM||0!=transitionsArray.length)){var edge=gEdges.getEdge(gNodes.nodes[i1],gNodes.nodes[i2]);null==edge&&(gEdges.addEdge(gNodes.nodes[i1],gNodes.nodes[i2]),edge=gEdges.edges[gEdges.edges.length-1]),-1==gEdges.edgeMap[gNodes.nodes[i1].id].indexOf(gNodes.nodes[i2].id)&&gEdges.edgeMap[gNodes.nodes[i1].id].push(gNodes.nodes[i2].id),gGraph.mode==gGraph.TM?edge.transitions[0]=transitionsArray:edge.transitions[0]=transitions.split("").sort()}})})},gTableMenu.init=function(){var charSet=gGraph.charSet;gGraph.epsilonEnabled&&(charSet+=gEpsilon),gGraph.mode==gGraph.TM&&(charSet=gGraph.tapeSet),charSet=charSet.split("");var header=d3.select(".tableEditor").insert("tr").selectAll("td").data(charSet);header.enter().append("td"),header.text(function(inputChar){return" "==inputChar&&gGraph.mode==gGraph.TM?gSquare:inputChar}),header.exit().remove();var headerTr=d3.select(".tableEditor").select("tr");headerTr.insert("td","td").text("Rejects"),headerTr.insert("td","td").text("Accepts"),headerTr.insert("td","td").text("Initial"),headerTr.insert("td","td").text(""),headerTr.append("td").text("Delete")},gTableMenu.draw=function(){if(gTableTopMenu.active){var charSet=gGraph.charSet;gGraph.epsilonEnabled&&(charSet+=gEpsilon),gGraph.mode==gGraph.TM&&(charSet=gGraph.tapeSet),charSet=charSet.split("");var table=d3.select(".tableEditor").selectAll("tr").filter(function(junk,i){return 0!=i}).data(gNodes.nodes),newRows=table.enter().append("tr");newRows.append("td").text(function(node){return node.name}),newRows.append("td").append("input").attr("type","radio").classed("initialBox",!0).each(function(node){this.checked=null!=gNodes.initial&&gNodes.initial.id==node.id}).on("change",function(node,i){this.checked?gNodes.setInitialByIndex(i):gNodes.clearInitial(),gGraph.draw()}),newRows.append("td").append("input").attr("type","checkbox").classed("acceptBox",!0).on("change",function(node,i){gNodes.setAcceptByIndex(i,this.checked),this.checked&&gNodes.setRejectByIndex(i,!1),gGraph.draw()}),newRows.append("td").append("input").attr("type","checkbox").classed("rejectBox",!0).on("change",function(node,i){gNodes.setRejectByIndex(i,this.checked),this.checked&&gNodes.setAcceptByIndex(i,!1),gGraph.draw()}),d3.selectAll(".acceptBox").each(function(junk,i){this.checked=gNodes.nodes[i].accept}),d3.selectAll(".rejectBox").each(function(junk,i){this.checked=gNodes.nodes[i].reject});var rows=table.selectAll("td").filter(function(){return null!=d3.select(this).select("input").filter(function(){return"text"==this.type}).node()}).data(charSet),td=rows.enter().append("td").classed("tm-cell",gGraph.mode==gGraph.TM).each(function(){gGraph.mode==gGraph.TM&&d3.select(this).style("line-height","30px")});td.append("input").attr("type","text").attr("size","10").attr("placeholder","go to").classed("gridInput",!0).each(function(character,i2,i1){this.character=character,this.i1=i1}),td.append("input").attr("type","text").attr("size","10").attr("maxlength","1").attr("placeholder","write").classed("gridInput",!0).each(function(character,i2,i1){this.character=character,this.i1=i1}),td.append("br");var form=td.append("form");form.append("label").text("move:"),form.append("input").attr("type","radio").attr("name","move").attr("checked",!0).classed("moveLeft",!0).each(function(character,i2,i1){this.character=character,this.i1=i1}),form.append("label").text("L"),form.append("input").attr("type","radio").attr("name","move").classed("moveRight",!0).each(function(character,i2,i1){this.character=character,this.i1=i1}),form.append("label").text("R"),rows.selectAll("input").each(function(character,i2){switch(i2){case 0:this.value=gTableMenu.getConnections(gNodes.nodes[this.i1].id,character);break;case 1:var result=gTableMenu.getResult(gNodes.nodes[this.i1].id,character);null!=result&&(this.value=result);break;case 2:var direction=gTableMenu.getDirection(gNodes.nodes[this.i1].id,character);0!=direction&&(this.checked=-1==direction);break;case 3:var direction=gTableMenu.getDirection(gNodes.nodes[this.i1].id,character);0!=direction&&(this.checked=1==direction)}}).on("blur",function(){gTableMenu.updateAll(),gTableMenu.draw()}),rows.exit().remove(),newRows.append("td").append("button").on("click",function(node,i){gNodes.removeByIndex(i),gGraph.draw()}).text("X"),table.exit().remove()}},gTableMenu.getConnections=function(source,character){var nodes=[];return gEdges.edges.forEach(function(edge){gGraph.mode==gGraph.TM?edge.transitions[0].forEach(function(state){edge.source.id==source&&state.from==character&&nodes.push(edge.target.name)}):edge.source.id==source&&-1!=edge.transitions[0].indexOf(character)&&nodes.push(edge.target.name)}),nodes.join(", ")},gTableMenu.getDirection=function(source,character){var direction=0;return gEdges.edges.forEach(function(edge){edge.transitions[0].forEach(function(state){edge.source.id==source&&state.from==character&&(direction=state.direction)})}),direction},gTableMenu.getResult=function(source,character){var result=null;return gEdges.edges.forEach(function(edge){edge.transitions[0].forEach(function(state){edge.source.id==source&&state.from==character&&(result=" "==state.to?"":state.to)})}),result};var gTableTopMenu={active:!1};gTableTopMenu.swap=function(){gTableTopMenu.active?(d3.select("svg").style("display","inline"),d3.select(".tableEditor, .tableEditorHeader").style("display","none"),d3.selectAll(".nontable").style("display","inline"),d3.selectAll(".nontableblock").style("display","block"),d3.select(".swapButton").text("Switch to Table View"),gTableTopMenu.active=!1,gTableMenu.updateAll()):(d3.select("svg").style("display","none"),d3.select(".tableEditor, .tableEditorHeader").style("display","table"),d3.selectAll(".nontable, .nontableblock").style("display","none"),d3.select(".swapButton").text("Switch to Editor View"),gNodes.deselectAll(),gEdges.deselectAll(),gTableTopMenu.active=!0),gGraph.mode==gGraph.DFA?d3.selectAll(".dfa-hide").style("display","none"):gGraph.mode==gGraph.NFA?d3.selectAll(".nfa-hide").style("display","none"):d3.selectAll(".tm-hide").style("display","none"),gGraph.draw()};var gTestMenu={NUM_CELLS:250,DISPLAY_TIME:4600,FADE_OUT_TIME:400};gTestMenu.init=function(){gTestMenu.reset(),gTestMenu.text="",gTestMenu.backupText="";var tape=d3.select(".tape-field");gTestMenu.showPlaceholder=!0;for(var i=0;i<gTestMenu.NUM_CELLS;i++)tape.append("input").attr("type","text").classed("tape-char",!0).attr("name","tapeChar[]").attr("maxlength",1).attr("readonly","readonly").on("click",gTestMenu.allowInput);d3.select(".tape-char-input").attr("maxlength",gTestMenu.NUM_CELLS).on("keydown",function(){13==d3.event.keyCode&&(gTestMenu.disallowInput(),gTestMenu.run())}),gTestMenu.disallowInput()},gTestMenu.reset=function(){gTestMenu.setRunning(!1),d3.select(".tape-char-input").node().value=gTestMenu.backupText||"",d3.selectAll(".current-tape-char").classed("current-tape-char",!1),d3.selectAll(".current-tape-char-solid").classed("current-tape-char-solid",!1),gTestMenu.disallowInput(),gTape.reset()},gTestMenu.allowInput=function(){gTestMenu.showPlaceholder=!1,gTestMenu.reset(),d3.select(".tape-char-input").node().value=gTestMenu.backupText,d3.selectAll(".tape-char").style("display","none"),d3.select(".tape-char-input").style("display","inline").each(function(){this.focus()})},gTestMenu.disallowInput=function(text){if(gTestMenu.backupText!=intersection(d3.select(".tape-char-input").node().value,gGraph.charSet)){gTestMenu.backupText=d3.select(".tape-char-input").node().value;var legal=intersection(gTestMenu.backupText,gGraph.charSet);gTestMenu.backupText.length!=legal.length&&gErrorMenu.displayError("Removing characters that aren't in the alphabet."),gTestMenu.backupText=legal}gTestMenu.text=void 0==text?gTestMenu.backupText:text;var displayString="Click to enter a test";d3.selectAll(".tape-char").style("display","inline").style("color",gTestMenu.showPlaceholder?"#bbb":"#fff").each(function(junk,i){var text=gTestMenu.showPlaceholder?displayString:gTestMenu.text;this.value=i<text.length?text[i]:""}),d3.select(".tape-char-input").style("display","none")},gTestMenu.unsetTransitions=function(){var missing=[];if(gGraph.mode==gGraph.DFA){var graph=gGraph.save(),table=gSimulator.convert(graph);for(var nodeId in table){var hasMissing=!1;for(var character in table[nodeId])hasMissing|=0==table[nodeId][character].length;hasMissing&&missing.push(gNodes.nodes[gNodes.getNodeIndex(nodeId)].name)}}return missing},gTestMenu.runTests=function(){var unset=gTestMenu.unsetTransitions();null==gNodes.initial?gErrorMenu.displayError("This automaton doesn't have a start state."):0!=unset.length?gErrorMenu.displayError("The following states have undefined transitions: "+unset.join(", ")):gModalMenu.open("testing")},gTestMenu.setRunning=function(running){running?(d3.selectAll(".running").style("display","inline"),d3.select(".runButton").text("Restart")):(d3.selectAll(".running").style("display","none"),d3.select(".runButton").text("Start"))},gTestMenu.run=function(){gTestMenu.reset();var unset=gTestMenu.unsetTransitions();null==gNodes.initial?gErrorMenu.displayError("This automaton doesn't have a start state."):0!=unset.length?gErrorMenu.displayError("The following states have undefined transitions: "+unset.join(", ")):(gTestMenu.setRunning(!0),gTape.show(),gTape.run())},gTestMenu.end=function(){gTestMenu.setRunning(!1),d3.selectAll(".current-tape-char").classed("current-tape-char",!1),d3.selectAll(".current-tape-char-solid").classed("current-tape-char-solid",!1),gTestMenu.disallowInput(),gTape.hide()},gTestMenu.step=function(){var unset=gTestMenu.unsetTransitions();null==gNodes.initial?gErrorMenu.displayError("No initial node is set"):0!=unset.length?gErrorMenu.displayError("The following nodes have undefined transitions: "+unset.join(", ")):(gTape.show(),gTape.step())};var gTopMenu={MAX_DISPLAYED_STATES:5,SELECTED_TEXT:"Selected states: "};gTopMenu.addNode=function(){gNodes.addNode(),gGraph.draw()},gTopMenu.setState=function(accepting,rejecting){gNodes.selectionIsEmpty()&&gErrorMenu.displayError("No states are selected"),gNodes.setAccepting(accepting),gNodes.setRejecting(rejecting),gGraph.draw()},gTopMenu.deleteSelected=function(){gNodes.selectionIsEmpty()&&gEdges.selectionIsEmpty()&&gErrorMenu.displayError("No states or transitions are selected"),gNodes.removeNodes()&&(gEdges.deleteSelected(),gGraph.draw())},gTopMenu.setInitial=function(){gNodes.selectionIsEmpty()?gErrorMenu.displayError("No states are selected"):gNodes.selectionSize()>1&&gErrorMenu.displayError("Multiple states are selected. Using the first one."),gNodes.setInitial(),gGraph.draw()},gTopMenu.snapToGrid=function(){gNodes.snapToGrid(),gGraph.draw()},gTopMenu.forcedDirectedLayout=function(){gNodes.forcedDirectedLayout(),gGraph.draw()},gTopMenu.loadFromServer=function(){gModalMenu.open("load"),gModalMenu.load.onOpen()},gTopMenu.save=function(){var BUTTON_TIMEOUT=2e3,name=gServer.name;gTopMenu.setSaveButton("Saving..."),!gModalMenu.saveas.isInvalidName(name)&&name?gServer.save(name,function(err,data){err?(gTopMenu.setSaveButton("Failed"),gErrorMenu.displayError("Save failed: couldn't connect to server.")):gTopMenu.setSaveButton("Saved!"),setTimeout(function(){gTopMenu.setSaveButton("Save")},BUTTON_TIMEOUT)}):name?(gErrorMenu.displayError('Saving to invalid name, use "Save As" to change name'),gTopMenu.setSaveButton("Save")):(gErrorMenu.displayError('Please first use "Save As" to give your automaton a name'),gTopMenu.setSaveButton("Save"))},gTopMenu.saveas=function(){gModalMenu.saveas.open()},gTopMenu.submit=function(){null!=gGraph.pset&&gModalMenu.submitModal.setPsetNumber(gGraph.pset),null!=gGraph.problem&&gModalMenu.submitModal.setProblemNumber(gGraph.problem),gModalMenu.open("submit")},gTopMenu.homepage=function(){window.location.href=getURLParent()+"index.html"},gTopMenu.draw=function(){var selectedText="",selected=gNodes.getSelected();selected.sort();for(var i=0;i<gTopMenu.MAX_DISPLAYED_STATES&&i<selected.length;i++)selectedText+=selected[i]+", ";selectedText=0==selected.length?"None":selectedText.substring(0,selectedText.length-2),selected.length>gTopMenu.MAX_DISPLAYED_STATES&&(selectedText+="...");var mode=gGraph.mode.toUpperCase();"TM"==mode&&(mode="Turing Machine");var pset=null==gGraph.pset?"":psets[gGraph.pset].name+", ",problem=null==gGraph.problem&&null==gGraph.pset?"":psets[gGraph.pset].problems[gGraph.problem].name+", ";d3.select(".current-pset-problem").text(pset+problem),d3.select(".current-mode").text(mode),d3.select(".current-alphabet").text(gGraph.charSet),"tm"===gGraph.mode&&gGraph.tapeSet&&sortString(gGraph.tapeSet)!==sortString(gGraph.charSet)&&(d3.select(".current-tape-set").style("display","inline"),d3.select(".current-tape-set-inner").text(gGraph.tapeSet)),d3.select("#selectedText").text(gTopMenu.SELECTED_TEXT+selectedText),d3.select(".acceptButton").classed("marked",gNodes.selectionIsAccepting()),d3.select(".rejectButton").classed("marked",gNodes.selectionIsRejecting()),d3.selectAll(".neitherButton").classed("marked",gNodes.selectionIsNeither())},gTopMenu.setSaveButton=function(text){d3.select(".saveTopButton").text(text)},gModalMenu.confirm={},gModalMenu.confirm.flag="",gModalMenu.confirm.open=function(){gModalMenu.open("confirm")},gModalMenu.confirm.clickConfirmBtn=function(){"submit"===gModalMenu.confirm.flag?gModalMenu.submitModal.clickConfirmBtn():"saveas"===gModalMenu.confirm.flag&&gModalMenu.saveas.clickConfirmBtn()},gModalMenu.confirm.clickCancelBtn=function(){"submit"===gModalMenu.confirm.flag?gModalMenu.submitModal.clickConfirmCancelBtn():"saveas"===gModalMenu.confirm.flag&&gModalMenu.saveas.clickConfirmCancelBtn()},gModalMenu.getEpsilon=function(){return gGraph.mode==gGraph.NFA&&d3.select(".epsilon").node().checked},gModalMenu.setEpsilon=function(included){d3.select(".epsilon").node().checked=included},gModalMenu.addAllEdgeChars=function(){gModalMenu.setEdgeChars(gGraph.charSet),gModalMenu.setEpsilon(!0)},gModalMenu.invertEdgeChars=function(){var chars=gGraph.charSet,badChars=gModalMenu.getEdgeCharacters();for(var badChar in badChars)chars=chars.replace(badChars[badChar],"");gModalMenu.setEdgeChars(chars),gModalMenu.setEpsilon(!gModalMenu.getEpsilon())},gModalMenu.addRemainingEdgeChars=function(){var missing=[],graph=gGraph.save(),table=gSimulator.convert(graph);for(var character in table[gEdges.editedEdge.source.id])0==table[gEdges.editedEdge.source.id][character].length&&missing.push(character);gModalMenu.setEdgeChars(gModalMenu.getEdgeCharacters()+missing.join(""))},gModalMenu.setEdgeChars=function(chars){d3.select(".edgeChars").node().value=chars},gModalMenu.getEdgeCharacters=function(){return d3.select(".edgeChars").node().value},gModalMenu.deleteEdge=function(){gEdges.removeEdge(gEdges.editedEdge.source,gEdges.editedEdge.target),gGraph.draw(),gModalMenu.close("edgeEntry")},gModalMenu.load={},gModalMenu.load.onOpen=function(){gModalMenu.open("load"),gModalMenu.load.setLoadMessage("Gathering saved automata..."),gServer.listSaved(function(err,data){if(err)return gErrorMenu.displayModalError("load","Could not gather saved automata..."),void d3.select(".load").selectAll("li").remove();var names=[];data.forEach(function(elem,index,arr){names.push(elem.name)}),gModalMenu.load.setLoadNames(names)})},gModalMenu.load.onClickLoadBtn=function(){gErrorMenu.clearModalErrors();var name=gModalMenu.load.getLoadName();return name?(gModalMenu.load.setLoadButton("Loading..."),void gServer.load(name,function(err,automata){if(err)return gErrorMenu.displayModalError("load","Failed to load"),void gModalMenu.load.setLoadButton("Load");gServer.changeName(name),gModalMenu.load.setLoadButton("Success!"),gGraph.charSet=automata.meta.charSet,gGraph.pset=automata.meta.pset,gGraph.problem=automata.meta.problem,"tm"===mode&&(gGraph.tapeSet=automata.meta.tapeSet);var mode=automata.meta.mode;mode!=gGraph.mode&&(window.location.href=getURLParent()+"tm.html?saved="+name),gGraph.load(automata),gGraph.draw(),setTimeout(function(){gModalMenu.load.setLoadButton("Load"),gModalMenu.close("load")},300)})):void gErrorMenu.displayModalError("load","No automaton selected")},gModalMenu.load.clickCancelBtn=function(){gErrorMenu.clearModalErrors(),gModalMenu.close("load")},gModalMenu.load.setLoadNames=function(names){var lis=d3.select(".loadNames").selectAll("li").data(names);lis.enter().append("li"),lis.classed("selected",!1).classed("load-nothing",!1).text(function(name){return name}).on("click",function(){d3.select(".loadNames").selectAll("li").classed("selected",!1),d3.select(this).classed("selected",!0)}).style("cursor","pointer"),lis.exit().remove(),0==names.length&&d3.select(".loadNames").append("li").classed("load-nothing",!0).append("p").classed("modal-description",!0).text("Nothing's been saved yet")},gModalMenu.load.getLoadName=function(){var node=d3.select(".loadNames").select("li.selected").node();return null==node?null:encodeURIComponent(d3.select(".loadNames").select("li.selected").text())},gModalMenu.load.setLoadButton=function(text){d3.select(".loadButton").text(text)},gModalMenu.load.setLoadMessage=function(message){d3.select(".loadNames").selectAll("li").remove(),d3.select(".loadNames").append("li").classed("load-nothing",!0).append("p").classed("modal-description",!0).text(message)};var gModalMenu={MAX_HEIGHT_PERCENT:.62};gModalMenu.open=function(type){gModalMenu.currentType=type,d3.select("."+type).style("display","inline"),d3.select(".overlay").style("display","inline")},gModalMenu.close=function(type){gErrorMenu.clearModalErrors(),d3.select("."+type).style("display","none"),d3.select(".overlay").style("display","none")},gModalMenu.closeCurrent=function(){gModalMenu.cancel(gModalMenu.currentType)},gModalMenu.submitOnEnter=function(type){13==event.keyCode&&gModalMenu.submit(type)},gModalMenu.submit=function(type){switch(gErrorMenu.clearModalErrors(),type){case"tmEdgeEntry":gEdges.tmEditComplete();break;case"edgeEntry":gEdges.editComplete();break;case"nodeEntry":gNodes.editComplete();break;case"testing":gSimulator.runTests();break;case"saveas":gModalMenu.saveas.clickSaveBtn();break;case"load":gModalMenu.load.onClickLoadBtn();break;case"submit":gModalMenu.submitModal.clickSubmitBtn();break;case"confirm":gModalMenu.confirm.clickConfirmBtn()}},gModalMenu.cancel=function(type){switch(type){case"edgeEntry":gEdges.editCancelled();break;case"confirm":gModalMenu.confirm.clickCancelBtn();break;case"saveas":gModalMenu.saveas.clickCancelBtn();break;case"load":gModalMenu.load.clickCancelBtn();break;default:gModalMenu.close(type)}},gModalMenu.getNodeName=function(){return d3.select(".nodeName").node().value},gModalMenu.setNodeName=function(name){d3.select(".nodeName").node().value=name},gModalMenu.setInitial=function(initial){d3.select(".nodeInitialCheckbox").node().checked=initial},gModalMenu.getInitial=function(){return d3.select(".nodeInitialCheckbox").node().checked},gModalMenu.setState=function(accept,reject){d3.selectAll(".modalAcceptButton").classed("marked",accept),d3.selectAll(".modalNeitherButton").classed("marked",!accept&&!reject),d3.selectAll(".modalRejectButton").classed("marked",reject)},gModalMenu.getAccepting=function(){return d3.select(".modalAcceptButton").classed("marked")},gModalMenu.getRejecting=function(){return d3.select(".modalRejectButton").classed("marked")},gModalMenu.deleteNode=function(){gNodes.deleteEdited()},gModalMenu.saveas={},gModalMenu.saveas.open=function(){gModalMenu.saveas.setSaveName(gServer.name),gModalMenu.open("saveas")},gModalMenu.saveas.clickSaveBtn=function(){gModalMenu.confirm.flag="saveas",gModalMenu.saveas.setSaveButton("Saving...");var rawName=gModalMenu.saveas.getSaveName();if(gModalMenu.saveas.isInvalidName(rawName))return gErrorMenu.displayModalError("saveas","Automaton name cannot be blank"),void gModalMenu.saveas.setSaveButton("Save");var name=encodeURIComponent(rawName);gServer.listSaved(function(err,data){function isPreviouslySaved(list,name){return list.some(function(elem,index,arr){return elem.name===name})}return err?(gErrorMenu.displayModalError("saveas","Save failed: couldn't connect to server."),void gModalMenu.saveas.setSaveButton("Save")):void(isPreviouslySaved(data,name)?(gModalMenu.close("saveas"),gModalMenu.confirm.open()):gModalMenu.saveas.save(function(){gModalMenu.close("saveas")}))})},gModalMenu.saveas.clickCancelBtn=function(){gErrorMenu.clearModalErrors(),gModalMenu.close("saveas")},gModalMenu.saveas.clickConfirmBtn=function(){gModalMenu.close("confirm"),gModalMenu.open("saveas"),gModalMenu.saveas.save(function(){
gModalMenu.close("saveas")})},gModalMenu.saveas.clickConfirmCancelBtn=function(){gModalMenu.close("saveas"),gModalMenu.close("confirm"),gModalMenu.saveas.setSaveButton("Save")},gModalMenu.saveas.save=function(){var name=gModalMenu.saveas.getSaveName();gServer.save(name,function(err,data){return err?(gErrorMenu.displayModalError("saveas","Save failed: couldn't connect to server."),void gModalMenu.saveas.setSaveButton("Save")):(gServer.changeName(name),gModalMenu.saveas.setSaveButton("Saved!"),void window.setTimeout(function(){gModalMenu.saveas.setSaveButton("Save"),gModalMenu.close("saveas")},1e3))})},gModalMenu.saveas.isInvalidName=function(name){return 0===name.replace(/\s/g,"").length},gModalMenu.saveas.getSaveName=function(){return d3.select(".saveText").node().value},gModalMenu.saveas.setSaveName=function(name){d3.select(".saveText").node().value=decodeURIComponent(name)},gModalMenu.saveas.setSaveButton=function(text){d3.select(".saveButton").text(text)},gModalMenu.submitModal={},gModalMenu.submitModal.init=function(){var psetSelect=d3.select(".pset").selectAll("option").data(psets);psetSelect.enter().append("option").attr("value",function(pset,i){return i}).text(function(pset,i){return pset.name}),d3.select(".pset").node().selectedIndex=0,gModalMenu.submitModal.changenumbers()},gModalMenu.submitModal.clickSubmitBtn=function(){function isPreviouslySaved(list,pset,problem){return list.some(function(elem,index,arr){var cur_pset_id=parseInt(elem.pset_id),cur_problem_id=parseInt(elem.problem_id);return cur_pset_id===pset&&cur_problem_id===problem})}gModalMenu.confirm.flag="submit";var pset=(JSON.stringify(gGraph.save()),gModalMenu.submitModal.getPsetNumber()),problem=gModalMenu.submitModal.getProblemNumber();gModalMenu.submitModal.setSubmitButton("Submitting..."),gServer.listSubmissions(function(data,err){return err?(gErrorMenu.displayModalError("submit","Failed to submit"),void gModalMenu.submitModal.setSubmitButton("Submit")):void(isPreviouslySaved(data,pset,problem)?(gModalMenu.close("submit"),gModalMenu.confirm.open()):gModalMenu.submitModal.submit(function(){gModalMenu.close("submit")}))})},gModalMenu.submitModal.clickCancelBtn=function(){gModalMenu.cancel("submit"),gErrorMenu.clearModalErrors()},gModalMenu.submitModal.clickConfirmBtn=function(){gModalMenu.close("confirm"),gModalMenu.open("submit"),gModalMenu.submitModal.submit(function(){gModalMenu.close("submit")})},gModalMenu.submitModal.clickConfirmCancelBtn=function(){gModalMenu.close("confirm"),gModalMenu.open("submit"),gModalMenu.submitModal.setSubmitButton("Submit")},gModalMenu.submitModal.changenumbers=function(){var psetNum=d3.select(".pset").node().selectedIndex,problemSelect=d3.select(".problem").selectAll("option").data(psets[psetNum].problems);problemSelect.enter().append("option"),problemSelect.attr("value",function(problem){return problem.charSet}).text(function(problem){return problem.name}),problemSelect.exit().remove(),d3.select(".problem").node().selectedIndex=0},gModalMenu.submitModal.submit=function(done){var automata=JSON.stringify(gGraph.save()),pset=gModalMenu.submitModal.getPsetNumber(),problem=gModalMenu.submitModal.getProblemNumber();return psets[pset].problems[problem].type!=gGraph.mode&&"nfa"==gGraph.mode?(gErrorMenu.displayModalError("submit","This automaton is an NFA, but the problem requires a DFA."),void gModalMenu.submitModal.setSubmitButton("Submit")):psets[pset].problems[problem].type!=gGraph.mode&&"dfa"==gGraph.mode?(gErrorMenu.displayModalError("submit","This automaton is a DFA, but the problem requires an NFA."),void gModalMenu.submitModal.setSubmitButton("Submit")):psets[pset].problems[problem].charSet!=gGraph.charSet?(gErrorMenu.displayModalError("submit","The alphabet for this automaton doesn't match the alphabet for that problem."),void gModalMenu.submitModal.setSubmitButton("Submit")):"tm"===gGraph.mode&&psets[pset].problems[problem].tapeSet!=gGraph.tapeSet?(gErrorMenu.displayModalError("submit","The tape alphabet for this turing machine doesn't match the tape alphabet for that problem."),void gModalMenu.submitModal.setSubmitButton("Submit")):void gServer.submit(automata,pset,problem,function(err){return err?(gErrorMenu.displayModalError("submit","Failed to submit"),void gModalMenu.submitModal.setSubmitButton("Submit")):(gModalMenu.submitModal.setSubmitButton("Success!"),void setTimeout(function(){gModalMenu.submitModal.setSubmitButton("Submit"),done()},1e3))})},gModalMenu.submitModal.getProblemNumber=function(){return d3.select(".problem").node().selectedIndex},gModalMenu.submitModal.getPsetNumber=function(){return d3.select(".pset").node().selectedIndex},gModalMenu.submitModal.setProblemNumber=function(index){d3.select(".problem").node().selectedIndex=index},gModalMenu.submitModal.setPsetNumber=function(index){d3.select(".pset").node().selectedIndex=index,gModalMenu.submitModal.changenumbers()},gModalMenu.submitModal.setSubmitButton=function(text){d3.select(".submitButton").text(text)},gModalMenu.focusRow=function(index){index=Math.max(index,0);var focused=!1;d3.selectAll(".bulkInput").each(function(junk,i){i==index&&(this.focus(),focused=!0)}),focused||gModalMenu.buildRow(!0)},gModalMenu.buildRow=function(focus){var row=d3.select(".testingHeader").append("tr");row.append("td").append("input").attr("type","text").classed("bulkInput",!0).each(function(){focus&&this.focus()}),row.append("td").append("input").attr("type","radio").classed("bulkAccept",!0),row.append("td").append("input").attr("type","radio").classed("bulkReject",!0),d3.selectAll(".bulkAccept").on("change",function(junk,i){gModalMenu.clearReject(i)}),d3.selectAll(".bulkReject").on("change",function(junk,i){gModalMenu.clearAccept(i)}),d3.selectAll(".bulkInput").on("keydown",function(junk,i){13==d3.event.keyCode||40==d3.event.keyCode?gModalMenu.focusRow(i+1):38==d3.event.keyCode&&gModalMenu.focusRow(i-1)})},gModalMenu.initBulk=function(){gModalMenu.buildRow(!1),d3.select(".modal-content").attr("max-height",gGraph.height*gModalMenu.MAX_HEIGHT_PERCENT)},gModalMenu.clearReject=function(index){d3.selectAll(".bulkReject").each(function(junk,i){i==index&&(this.checked=!1)})},gModalMenu.clearAccept=function(index){d3.selectAll(".bulkAccept").each(function(junk,i){i==index&&(this.checked=!1)})},gModalMenu.tmEdge={},gModalMenu.tmEdge.focusTmRow=function(index){index=Math.max(index,0);var focused=!1;d3.selectAll(".tmEdgeInput").each(function(junk,i){i==index&&(this.focus(),focused=!0)}),focused||gModalMenu.tmEdge.buildTmRow(!0)},gModalMenu.tmEdge.setTmEdgeStates=function(states){0==states.length&&states.push({direction:1,to:"",from:""});for(var newRows=states.length-d3.selectAll(".tmEdge > tr").size(),i=0;newRows>i;i++)gModalMenu.tmEdge.buildTmRow(!1);var rows=d3.select(".tmEdge").selectAll("tr").filter(function(junk,i){return 0!=i}).data(states);rows.select("td > .edgeLeft").each(function(state){this.checked=-1==state.direction}),rows.select("td > .edgeRight").each(function(state){this.checked=1==state.direction}),rows.selectAll("td > .tmEdgeChars").each(function(junk,i2,i1){this.value=1==i2?states[i1].to:states[i1].from}),rows.exit().remove()},gModalMenu.tmEdge.getTmEdgeStates=function(){var states=[];return d3.select(".tmEdge").selectAll("tr").filter(function(junk,i){return 0!=i}).each(function(){var state={},row=d3.select(this);state.direction=row.select("td > .edgeLeft").node().checked?-1:1,state.from=row.selectAll("td > .tmEdgeChars")[0][0].value,state.to=row.selectAll("td > .tmEdgeChars")[0][1].value,states.push(state)}),states},gModalMenu.tmEdge.buildTmRow=function(focus){var row=d3.select(".tmEdge").append("tr");row.append("td").append("input").attr("type","text").attr("size",2).attr("maxlength",1).classed("tmEdgeChars",!0).each(function(){focus&&this.focus()}),row.append("td").append("input").attr("type","text").attr("size",2).attr("maxlength",1).classed("tmEdgeChars",!0);var radioTd=row.append("td");radioTd.append("input").attr("type","radio").classed("edgeLeft",!0),radioTd.append("label").text(" L "),radioTd.append("input").attr("type","radio").attr("checked",!0).classed("edgeRight",!0),radioTd.append("label").text(" R "),row.append("td").append("button").classed("button-delete",!0).text("X"),gModalMenu.tmEdge.updateTmDeleteButtons(),d3.selectAll(".edgeLeft").on("change",function(junk,i){gModalMenu.tmEdge.clearRight(i)}),d3.selectAll(".edgeRight").on("change",function(junk,i){gModalMenu.tmEdge.clearLeft(i)}),d3.selectAll(".tmEdgeChars").on("keydown",function(junk,i){13==d3.event.keyCode||40==d3.event.keyCode?gModalMenu.tmEdge.focusTmRow(i+1):38==d3.event.keyCode&&gModalMenu.tmEdge.focusTmRow(i-1)})},gModalMenu.tmEdge.updateTmDeleteButtons=function(){d3.selectAll(".button-delete").on("click",function(junk,i){d3.select(".tmEdge").selectAll("tr").filter(function(junk2,i2){return i==i2}).remove(),gModalMenu.tmEdge.updateTmDeleteButtons()})},gModalMenu.tmEdge.initTmEdit=function(){d3.select(".modal-content").attr("max-height",gGraph.height*gModalMenu.MAX_HEIGHT_PERCENT)},gModalMenu.tmEdge.clearLeft=function(index){d3.selectAll(".edgeLeft").each(function(junk,i){i==index&&(this.checked=!1)})},gModalMenu.tmEdge.clearRight=function(index){d3.selectAll(".edgeRight").each(function(junk,i){i==index&&(this.checked=!1)})},gSimulator.ACCEPT="ACCEPT",gSimulator.REJECT="REJECT",gSimulator.NEITHER="NEITHER",gSimulator.runTests=function(){var inputs=[],illegalsExist=!1;d3.selectAll(".bulkInput").each(function(){var test=intersection(this.value,gGraph.charSet);illegalsExist|=test.length!=this.value.length,this.value=test,inputs.push({testCase:test,expected:gSimulator.NEITHER})}),d3.selectAll(".bulkAccept").each(function(junk,i){this.checked&&(inputs[i].expected=gSimulator.ACCEPT)}),d3.selectAll(".bulkReject").each(function(junk,i){this.checked&&(inputs[i].expected=gSimulator.REJECT)}),illegalsExist&&gErrorMenu.displayModalError("testing","Removing characters not in alphabet");var results=[],graph=gGraph.save();inputs.forEach(function(input){results.push({accepted:gSimulator.run(graph,input.testCase),input:gSimulator.output,expected:input.expected})});var rows=d3.select(".testingResults").selectAll("tr").data(results),entered=rows.enter().append("tr");entered.append("td").attr("width","60%").style("text-align","left"),entered.append("td").attr("width","20%").style("text-align","center"),entered.append("td").attr("width","20%").style("text-align","center"),rows.each(function(result){d3.select(this).selectAll("td").text(function(junk,i){switch(i){case 0:return result.accepted==gSimulator.TIMEOUT?"Timed out":result.input;case 1:return result.accepted==gSimulator.TIMEOUT?"-":result.accepted?"A":"R";case 2:if(result.expected===gSimulator.NEITHER||result.accepted==gSimulator.TIMEOUT)return"-";var correct=!(result.expected===gSimulator.ACCEPT^result.accepted);return correct?"Y":"N"}})}),rows.exit().remove()};var gDFASimulator={};gDFASimulator.step=function(graph,initial,input,index){var transitionTable=gSimulator.convert(graph);return transitionTable[initial][input[index]][0]},gDFASimulator.run=function(graph,input){gSimulator.output=input;for(var transitionTable=gSimulator.convert(graph),current=graph.nodes.initial,i=0;i<input.length;i++){var choices=transitionTable[current][input[i]];if(0==choices.length)return!1;current=choices[0]}for(var i=0;i<graph.nodes.nodes.length;i++)if(graph.nodes.nodes[i].id==current)return graph.nodes.nodes[i].accept;return!1};var gNFASimulator={};gNFASimulator.run=function(graph,input){gSimulator.output=input;var transitionTable=gSimulator.convert(graph),queue=new Queue,used={};for(queue.enqueue({current:graph.nodes.initial,index:0}),used[graph.nodes.initial+" 0"]=!0;!queue.isEmpty();){var entry=queue.dequeue();if(entry.index==input.length){for(var i=0;i<graph.nodes.nodes.length;i++)if(graph.nodes.nodes[i].id==entry.current&&graph.nodes.nodes[i].accept)return!0}else for(var choices=transitionTable[entry.current][input[entry.index]],i=0;i<choices.length;i++){var newEntry={current:choices[i],index:entry.index+1};used[newEntry.current+" "+newEntry.index]||(used[newEntry.current+" "+newEntry.index]=!0,queue.enqueue(newEntry))}for(var epsilons=transitionTable[entry.current][gEpsilon],i=0;i<epsilons.length;i++){var newEntry={current:epsilons[i],index:entry.index};used[newEntry.current+" "+newEntry.index]||(used[newEntry.current+" "+newEntry.index]=!0,queue.enqueue(newEntry))}}return!1};var gSimulator={TIMEOUT:"timeout"};gSimulator.init=function(){var simulator=gGraph.mode==gGraph.DFA?gDFASimulator:gGraph.mode==gGraph.NFA?gNFASimulator:gTMSimulator;gSimulator.run=simulator.run,gSimulator.step=simulator.step},gSimulator.convert=function(graph){var transitionTable={},charSet=gGraph.charSet+(gGraph.epsilonEnabled?gEpsilon:"");return graph.nodes.nodes.forEach(function(node){transitionTable[node.id]={};for(var i=0;i<charSet.length;i++)transitionTable[node.id][charSet[i]]=[]}),graph.edges.edges.forEach(function(edge){edge.transitions[0].forEach(function(input){transitionTable[edge.source][input].push(edge.target)})}),transitionTable};var gTape={SELECT_RADIUS:50};gTape.init=function(){d3.select(".tape").append("circle").style("fill","none").style("stroke","blue").attr("r",gTape.SELECT_RADIUS),gTape.hide(),gTape.done=!0,gTape.running=!1},gTape.run=function(){var input=gTestMenu.text;gTape.done=!1,gTape.running=!0,d3.select(".tape").select("circle").style("stroke","blue"),gTape.input=input.split(""),gTape.index=0,gTape.follow=gTape.current=gNodes.initial,gTape.draw()},gTape.drawResult=function(accepted){if(!gTape.done){var message="Run finished, "+(accepted?"accept":"reject")+'ing string "'+gTape.input.join("")+'"';!gTape.follow||gTape.follow.accept||gTape.follow.reject||(message+=" because of a missing transition"),gErrorMenu.displayMessage(message,!1,accepted?"accepting run-finished":"rejecting run-finished"),gTape.done=!0}},gTape.draw=function(){var circle=d3.select(".tape").select("circle");if(gTape.follow){var duration=gTape.follow!=gTape.prev&&1==circle.style("opacity")?100:0;circle.transition().duration(duration).attr("cx",gTape.follow.x).attr("cy",gTape.follow.y).style("opacity",1),d3.select(".stepButton").text("Step").node().disabled=!1,gTape.isRejecting()?(circle.style("stroke","red"),d3.select(".stepButton").text("Completed").node().disabled=!0,gTape.drawResult(!1)):gTape.isAccepting()&&(circle.style("stroke","green"),d3.select(".stepButton").text("Completed").node().disabled=!0,gTape.drawResult(!0))}else circle.style("opacity",0);var currentTapeClass=gGraph.mode==gGraph.TM?"current-tape-char-solid":"current-tape-char";gTape.running&&gTape.index<=gTape.input.length&&d3.selectAll(".tape-char").classed(currentTapeClass,function(junk,i){return d3.select(this).classed(currentTapeClass)||gTape.index!=i||(this.focus(),this.blur()),gTape.index==i}),gTape.prev=gTape.follow},gTape.isAccepting=function(){return gGraph.mode==gGraph.DFA?"undefined"!=typeof gTape.current&&gTape.current.accept&&gTape.index==gTape.input.length:"undefined"!=typeof gTape.current&&gTape.current.accept},gTape.isRejecting=function(){return gGraph.mode==gGraph.DFA?"undefined"==typeof gTape.current||!gTape.current.accept&&gTape.index==gTape.input.length:"undefined"==typeof gTape.current||gTape.current.reject},gTape.show=function(){d3.select(".tape").style("opacity",1)},gTape.reset=function(){gTape.done=!0,gTape.running=!1,gTape.follow=null,gTape.draw()},gTape.hide=function(){gTape.reset(),d3.select(".tape").style("opacity",0)},gTape.step=function(){if(!gTape.running)return void gTape.run();if(!gTape.isRejecting()&&!gTape.isAccepting()){if(gGraph.mode==gGraph.DFA){var next=gDFASimulator.step(gGraph.save(),gTape.current.id,gTape.input,gTape.index++);gTape.current=gNodes.nodes[gNodes.getNodeIndex(next)]}else{var next=gTMSimulator.step(gGraph.save(),gTape.current.id,gTape.input.join(""),gTape.index);gTape.current=gNodes.nodes[gNodes.getNodeIndex(next.initial)],gTape.input=next.input.split(""),gTape.index=next.index,gTestMenu.disallowInput(gTape.input.join(""))}"undefined"!=typeof gTape.current&&(gTape.follow=gTape.current)}gTape.draw()};var gTMSimulator={MAX_ITER:1e5},gBlank=" ",gSquare=String.fromCharCode(9633);gTMSimulator.convert=function(graph){var transitionTable={},charSet=gGraph.tapeSet+(gGraph.epsilonEnabled?gEpsilon:"");return graph.nodes.nodes.forEach(function(node){transitionTable[node.id]={};for(var i=0;i<charSet.length;i++)transitionTable[node.id][charSet[i]]=null}),graph.edges.edges.forEach(function(edge){edge.transitions[0].forEach(function(input){transitionTable[edge.source][input.from]=JSON.parse(JSON.stringify(input)),transitionTable[edge.source][input.from].target=edge.target})}),transitionTable},gTMSimulator.step=function(graph,initial,input,index){var transitionTable=gTMSimulator.convert(graph);transitionTable[initial][input[index]];return gTMSimulator.stepState(transitionTable,{initial:initial,input:input,index:index})},gTMSimulator.stepState=function(table,state){var input=state.input;input.length==state.index&&(input+=gBlank);var transition=table[state.initial][input[state.index]];if(void 0==transition)return{initial:void 0,input:input,index:state.index};var result={initial:transition.target,index:state.index+transition.direction};for(result.input=input.substring(0,state.index)+transition.to+input.substring(state.index+1);result.index<0;)result.index++,result.input=gBlank+result.input;for(;result.index>=result.input.length;)result.input+=gBlank;return result},gTMSimulator.run=function(graph,input){for(var state={initial:graph.nodes.initial,input:input,index:0},transitionTable=gTMSimulator.convert(graph),i=0;i<gTMSimulator.MAX_ITER;i++){if(void 0==state.initial)return gSimulator.output=state.input,!1;var current=graph.nodes.nodes[gNodes.getNodeIndex(state.initial)];if(current.accept)return gSimulator.output=state.input,!0;if(current.reject)return gSimulator.output=state.input,!1;i<gTMSimulator.MAX_ITER-1&&(state=gTMSimulator.stepState(transitionTable,state))}return gSimulator.output=state.input,gSimulator.TIMEOUT};var gServerMock={};gServerMock.url_prefix="/class/cs103/cgi-bin/restricted",gServerMock.name="automata",gServerMock.save=function(){var name=gModalMenu.getSaveName();if(0==name.replace(/\s/g,"").length)return void gErrorMenu.displayError("Automata name cannot be blank");gServer.name=name;var save_url="/api/save.php";gModalMenu.setSaveButton("Saving...");var stringGraph=JSON.stringify(gGraph.save()),pack={automata:stringGraph,name:name};d3.xhr(gServer.url_prefix+save_url).header("Content-Type","application/json").post(JSON.stringify(pack),function(err,rawData){err?gModalMenu.setSaveButton("Failed"):gModalMenu.setSaveButton("Saved!"),window.setTimeout(function(){gModalMenu.setSaveButton("Save"),gModalMenu.close("save")},1e3)})},gServerMock.load=function(){var selected=gModalMenu.getLoadName(),get_url="/api/loadFromSaved.php?name="+selected;d3.xhr(gServer.url_prefix+get_url).header("Content-Type","application/json").get(function(err,data){err&&console.log(err);var json_data=JSON.parse(data.response);gGraph.load(JSON.parse(json_data[0].automata)),gGraph.draw(),gModalMenu.close("load")})},gServerMock.submit=function(){var submit_url="/api/submit.php",automata=JSON.stringify(gGraph.save()),pset=1,problem=1,pack={automata:automata,pset:pset,problem:problem};d3.xhr(gServer.url_prefix+submit_url).header("Content-Type","application/json").post(JSON.stringify(pack),function(err,rawData){err?console.log(err):console.log(rawData)})},gServerMock.listSubmissions=function(){var listSubmissions_url="/api/listSubmissions.php";d3.xhr(gServer.url_prefix+listSubmissions_url).header("Content-Type","application/json").get(function(err,rawData){if(err)console.log(err);else{console.log(rawData);JSON.parse(rawData.response)}})},gServerMock.loadSubmission=function(){var pset=1,problem=1,loadFromSubmissions_url="/api/loadFromSubmissions.php",full_url=gServer.url_prefix+loadFromSubmissions_url+"?problem="+problem+"&pset="+pset;d3.xhr(full_url).header("Content-Type","application/json").get(function(err,rawData){if(err)console.log(err);else{console.log(rawData);var data=JSON.parse(rawData.response),automata=JSON.parse(data[0].automata);gGraph.load(automata),gGraph.draw()}})},gServerMock.listSaved=function(callback){callback([{name:"test1"},{name:"test2"}])},gServerMock.getSunetid=function(callback){callback("mprecup")},null!=getURLParam("mock")&&(gServer=gServerMock);var gServer={};gServer.url_prefix="/class/cs103/cgi-bin/restricted",gServer.name="",gServer.changeName=function(name){var new_url=setURLParam("saved",name,window.location.href);window.history.pushState({},"",new_url),gServer.name=name},gServer.save=function(name,callback){var save_url="/api/save.php",stringGraph=JSON.stringify(gGraph.save()),pack={automata:stringGraph,name:name};d3.xhr(gServer.url_prefix+save_url).header("Content-Type","application/json").post(JSON.stringify(pack),function(err,rawData){err?callback(err,null):callback(err,rawData)})},gServer.load=function(selected,callback){var get_url="/api/loadFromSaved.php?name="+selected;d3.xhr(gServer.url_prefix+get_url).header("Content-Type","application/json").get(function(err,res){var json_data=JSON.parse(res.response);callback(err,JSON.parse(json_data[0].automata))})},gServer.submit=function(automata,pset,problem,callback){var submit_url="/api/submit.php",pack={automata:automata,pset:pset,problem:problem},packed=JSON.stringify(pack);d3.xhr(gServer.url_prefix+submit_url).header("Content-Type","application/json").post(packed,function(err,rawData){callback(err)})},gServer.listSubmissions=function(callback){var listSubmissions_url="/api/listSubmissions.php";try{d3.xhr(gServer.url_prefix+listSubmissions_url).header("Content-Type","application/json").get(function(err,rawData){var data=rawData?JSON.parse(rawData.response):null;callback(data,err)})}catch(err){console.error("Could not connect to server")}},gServer.loadSubmission=function(pset,problem,callback){var loadFromSubmissions_url="/api/loadFromSubmissions.php",full_url=gServer.url_prefix+loadFromSubmissions_url+"?problem="+problem+"&pset="+pset;d3.xhr(full_url).header("Content-Type","application/json").get(function(err,rawData){err?callback(err,null):callback(err,JSON.parse(rawData.response))})},gServer.listSaved=function(callback){var listSaved_url="/api/listSaved.php";try{d3.xhr(gServer.url_prefix+listSaved_url).header("Content-Type","application/json").get(function(err,data){err?callback(err,null):callback(err,JSON.parse(data.response))})}catch(err){console.error("Could not connect to server")}},gServer.getSunetid=function(callback){var getSunetid_url="/api/getSunetid.php";try{d3.xhr(gServer.url_prefix+getSunetid_url).header("Content-Type","application/json").get(function(err,data){callback(err?null:data.response)})}catch(err){console.error("Could not connect to server")}};
//# sourceMappingURL=sourceMap.map